(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{432:function(t,a,s){"use strict";s.r(a);var n=s(44),r=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"卡顿优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#卡顿优化"}},[t._v("#")]),t._v(" 卡顿优化")]),t._v(" "),s("p",[t._v("[TOC]")]),t._v(" "),s("blockquote",[s("p",[t._v("解决方案：")]),t._v(" "),s("ol",[s("li",[t._v("打印方法执行时间；")]),t._v(" "),s("li",[t._v("监控消息队列；")]),t._v(" "),s("li",[t._v("模拟器上hook ArtMethod，打印执行时间。")])])]),t._v(" "),s("h3",{attrs:{id:"一、概要"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、概要"}},[t._v("#")]),t._v(" 一、概要")]),t._v(" "),s("p",[t._v("​\t对用户来说，内存占用高、耗费电、耗费流量不容易被发现，但对卡顿特别敏感，很容易感受到。另一方面，卡顿难以定位排查，产生的原因也错综复杂，跟CPU、内存、I/O都可能有关，跟用户当时的系统环境也有很大关系。")]),t._v(" "),s("p",[t._v("​\t造成卡顿的原因可能有千百种，"),s("strong",[t._v("不过最终都会反映到 CPU 时间上")]),t._v("。我们可以把 CPU 时间分为两种："),s("strong",[t._v("用户时间和系统时间")]),t._v("。用户时间就是执行用户态应用程序代码所消耗的时间；系统时间就是执行内核态系统调用所消耗的时间，包括 I/O、锁、中断以及其他系统调用的时间。")]),t._v(" "),s("p",[t._v("​\t所以，出现卡顿问题后，首先我们应该查看 "),s("strong",[t._v("CPU 的使用率。")])]),t._v(" "),s("h3",{attrs:{id:"二、卡顿排查工具"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、卡顿排查工具"}},[t._v("#")]),t._v(" 二、卡顿排查工具")]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("选择哪种工具，需要看具体的场景。我来汇总一下，如果需要分析 Native 代码的耗时，可以选择 Simpleperf；如果想分析系统调用，可以选择 systrace；如果想分析整个程序执行流程的耗时，可以选择 Traceview 或者插桩版本的 systrace。")])]),t._v(" "),s("h4",{attrs:{id:"_1-traceview"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-traceview"}},[t._v("#")]),t._v(" 1. TraceView")]),t._v(" "),s("p",[s("strong",[t._v("Traceview的作用：")]),t._v(" "),s("strong",[t._v("(1).")]),t._v(" 查看跟踪代码的执行时间，分析哪些是耗时操作。\n"),s("strong",[t._v("(2).")]),t._v(" 可以用于跟踪方法的调用，尤其是Android Framework层的方法调用关系。\n"),s("strong",[t._v("(3).")]),t._v(" 可以方便的查看线程的执行情况，某个方法执行时间、调用次数、在总体中的占比等，从而定位性能点。")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Debug")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("startMethodTracing")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sample"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Debug")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("stopMethodTracing")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h4",{attrs:{id:"_2-systrace"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-systrace"}},[t._v("#")]),t._v(" 2. Systrace")]),t._v(" "),s("p",[t._v("​\t它可帮助开发者收集Android关键子系统（如Surfaceflinger、WindowManagerService等Framework部分关键模块、服务）的运行信息，从而帮助开发者更直观的分析系统瓶颈，改进性能。")]),t._v(" "),s("p",[t._v("我通常使用 systrace 跟踪系统的 I/O 操作、CPU 负载、Surface 渲染、GC 等事件。\n"),s("strong",[t._v("(1).应用层代码添加systrace跟踪方式:")])]),t._v(" "),s("p",[t._v("Trace.beginSection(“TEST”);\nTrace.endSection();\n"),s("strong",[t._v("(2).framework的java层代码添加systrace跟踪方式:")]),t._v("\nTrace.traceBegin(Trace.TRACE_TAG_VIEW, “performTraversals”);\nTrace.traceEnd(Trace.TRACE_TAG_VIEW);\n也可以使用：\nATRACE_BEGIN(“TEST”);\nATRACE_END();\n"),s("strong",[t._v("(3).framework的native代码添加systrace跟踪方式:")]),s("br"),t._v("\nATRACE_INIT();\nATRACE_CALL();")]),t._v(" "),s("h4",{attrs:{id:"_3-nanoscope"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-nanoscope"}},[t._v("#")]),t._v(" 3. Nanoscope")]),t._v(" "),s("p",[t._v("​\tUber的开源工具(性能损耗小)，它的实现原理是直接修改 Android 虚拟机源码，"),s("strong",[t._v("在ArtMethod执行入口和执行结束位置增加埋点代码，将所有的信息先写到内存")]),t._v("，等到 trace 结束后才统一生成结果文件。")]),t._v(" "),s("p",[t._v("​\t缺点：需要root权限，目前只支持neuxs6P手机。")]),t._v(" "),s("h4",{attrs:{id:"_4-simpleperf"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-simpleperf"}},[t._v("#")]),t._v(" 4. Simpleperf")]),t._v(" "),s("p",[t._v("​\t分析native代码。")]),t._v(" "),s("h3",{attrs:{id:"三、监控"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、监控"}},[t._v("#")]),t._v(" 三、监控")]),t._v(" "),s("h4",{attrs:{id:"_1-消息队列"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-消息队列"}},[t._v("#")]),t._v(" 1. 消息队列")]),t._v(" "),s("h4",{attrs:{id:"_2-插桩"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-插桩"}},[t._v("#")]),t._v(" 2. 插桩")]),t._v(" "),s("h4",{attrs:{id:"_3-profilo"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-profilo"}},[t._v("#")]),t._v(" 3. Profilo")]),t._v(" "),s("p",[t._v("​\t利用linux内核实现，集成 atrace 功能。ftrace 所有性能埋点数据都会通过 trace_marker 文件写入内核缓冲区，Profilo 通过 PLT  Hook 拦截了写入操作，选择部分关心的事件做分析。这样所有 systrace 的探针我们都可以拿到，例如四大组件生命周期、锁等待时间、类校验、GC 时间等。")]),t._v(" "),s("h4",{attrs:{id:"_4-帧率-生命周期-线程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-帧率-生命周期-线程"}},[t._v("#")]),t._v(" 4. 帧率&生命周期&线程")]),t._v(" "),s("p",[s("strong",[t._v("参考：")])]),t._v(" "),s("ul",[s("li",[s("p",[s("a",{attrs:{href:"https://developer.android.google.cn/topic/performance/vitals/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Android Vitals google监控"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://github.com/Tencent/matrix#matrix_android_cn",target:"_blank",rel:"noopener noreferrer"}},[t._v("Tencent matrix 微信APM监控"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://github.com/facebookincubator/profilo",target:"_blank",rel:"noopener noreferrer"}},[t._v("Facebook Profilo监控"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://github.com/Tencent/Hardcoder",target:"_blank",rel:"noopener noreferrer"}},[t._v("Tencent Hardcoder"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("strong",[t._v("Hardcoder 是一套 Android APP 与系统间的通信解决方案，突破了 APP 只能调用系统标准 API，无法直接调用系统底层硬件资源的问题，让 Android APP 和系统能实时通信。APP 能充分调度系统资源如 CPU 频率，大小核，GPU 频率等来提升 APP 性能，系统能够从 APP 侧获取更多信息以便更合理提供各项系统资源。同时，对于 Android 缺乏标准接口实现的功能，APP 和系统也可以通过该框架实现机型适配和功能拓展。")])]),t._v(" "),s("p",[t._v("Hardcoder 在微信的启动、发送视频、小程序启动等重度场景平均优化效果达 10%-30%；在手机 QQ 的启动、打开聊天界面、发送图片等场景的平均优化效果达 10%-50%。该框架目前已接入 OPPO、vivo、华为、小米、三星、魅族等主流手机厂商，覆盖 4.6 亿+ 设备量。")])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://github.com/uber/nanoscope",target:"_blank",rel:"noopener noreferrer"}},[t._v("Uber nanoscope 性能分析损耗小"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://developer.android.com/studio/profile/generate-trace-logs#java",target:"_blank",rel:"noopener noreferrer"}},[t._v("TraceView"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://source.android.com/devices/tech/debug/systrace?hl=zh-cn",target:"_blank",rel:"noopener noreferrer"}},[t._v("systrace"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://github.com/wasabeef/Takt",target:"_blank",rel:"noopener noreferrer"}},[t._v("帧率检测Choreographer"),s("OutboundLink")],1)])])]),t._v(" "),s("br"),t._v(" "),s("h2",{attrs:{id:"一、卡顿现场信息搜集"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、卡顿现场信息搜集"}},[t._v("#")]),t._v(" 一、卡顿现场信息搜集")]),t._v(" "),s("h3",{attrs:{id:"_1-手机信息和用户信息"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-手机信息和用户信息"}},[t._v("#")]),t._v(" 1. 手机信息和用户信息")]),t._v(" "),s("p",[t._v("手机型号、系统、网络状态、用户id等；")]),t._v(" "),s("h2",{attrs:{id:"_2-cpu情况"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-cpu情况"}},[t._v("#")]),t._v(" 2. Cpu情况")]),t._v(" "),s("h4",{attrs:{id:"_1-cpu核心数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-cpu核心数"}},[t._v("#")]),t._v(" 1. cpu核心数")]),t._v(" "),s("h4",{attrs:{id:"_2-cpu使用率"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-cpu使用率"}},[t._v("#")]),t._v(" 2. cpu使用率")]),t._v(" "),s("p",[t._v("通过"),s("code",[t._v("/proc/stat")]),t._v(" 采样计算(Android8.0之后权限禁用):")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#可以分别计算 用户态、内核态、ioWait占用的cpu比例")]),t._v("\nCPU使用率＝（用户态Jiffies＋系统态Jiffies）／总Jiffies\ncpu:68%"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("user:40%,system:22%,ioWait:4%"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("h2",{attrs:{id:"_3-内存情况"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-内存情况"}},[t._v("#")]),t._v(" 3. 内存情况")]),t._v(" "),s("h2",{attrs:{id:"一、ui渲染机制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、ui渲染机制"}},[t._v("#")]),t._v(" 一、UI渲染机制")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("每16毫秒发出垂直信号，触发对UI进行渲染，渲染过程需要在16ms内完成，否则掉帧(就是卡顿)；")])]),t._v(" "),s("li",[s("p",[t._v("16ms需要做的事：")]),t._v(" "),s("p",[t._v("有了对Android渲染机制基本的认识以后，那么我们的卡顿的原因就在于没有办法在16ms内完成该完成的操作，而主要因素是在于没有必要的layouts、invalidations、Overdraw。渲染的过程是由CPU与GPU协作完成，下面一张图很好的展示出了CPU和GPU的工作，以及潜在的问题，检测的工具和解决方案。")]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"/Users/xin/books/docs/Android/08业务实战/images/ui_render_16ms.png"}})])]),t._v(" "),s("h3",{attrs:{id:"解决办法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解决办法"}},[t._v("#")]),t._v(" "),s("strong",[t._v("解决办法：")])]),t._v(" "),s("ul",[s("li",[t._v("通过Hierarchy Viewer去检测渲染效率，去除不必要的嵌套；")]),t._v(" "),s("li",[t._v("通过Show GPU Overdraw去检测Overdraw，最终可以通过移除不必要的背景以及使用canvas.clipRect解决大多数问题（"),s("strong",[t._v("clipRect的妙用")]),t._v("）；")]),t._v(" "),s("li",[s("strong",[t._v("对自定义view进行优化")]),t._v("；")])]),t._v(" "),s("h2",{attrs:{id:"二、线上监控"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、线上监控"}},[t._v("#")]),t._v(" 二、线上监控")]),t._v(" "),s("h3",{attrs:{id:"_1-利用ui线程looper打印的日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-利用ui线程looper打印的日志"}},[t._v("#")]),t._v(" 1. 利用UI线程Looper打印的日志!!!")]),t._v(" "),s("blockquote",[s("p",[t._v("自定义Looper的Printer实现，计算每个消息执行时间，大于阈值，打印堆栈信息。")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取消息执行时间")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BlockDetectByPrinter")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("start")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Looper")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMainLooper")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setMessageLogging")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Printer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" START "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('">>>>> Dispatching"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" END "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<<<<< Finished"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n            "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" x"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("startsWith")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("START"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LogMonitor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("startMonitor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("startsWith")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("END"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LogMonitor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("removeMonitor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 打印堆栈")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Looper")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMainLooper")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getThread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getStackTrace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 日志分析")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.")]),t._v(" 监测生命周期函数"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),t._v("ms"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Finished")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("to")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Handler")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("ActivityThread")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("H")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v("b87a0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.")]),t._v(" 监测一帧时间包括动画、输入、绘制"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v("ms"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Finished")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("to")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Handler")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("Choreographer")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FrameHandler")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \n\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.")]),t._v(" 监测UI事件"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),t._v("ms"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nclick"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Finished")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("to")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Handler")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("ViewRootImpl")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ViewRootHandler")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("c043eb5"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("View")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PerformClick")]),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@2c9289b")]),t._v("\nlongClick"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Finished")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("to")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Handler")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("ViewRootImpl")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ViewRootHandler")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("c043eb5"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("View")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CheckForLongPress")]),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@15e1c49")]),t._v("\n\n")])])]),s("h3",{attrs:{id:"_2-利用choreographer"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-利用choreographer"}},[t._v("#")]),t._v(" 2. 利用Choreographer")]),t._v(" "),s("h3",{attrs:{id:"_3-dumpsys命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-dumpsys命令"}},[t._v("#")]),t._v(" 3. Dumpsys命令")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" adb shell dumpsys gfxinfo "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("PACKAGE_NAME"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nStats since: 752958278148ns\n    Total frames rendered: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("82189")]),t._v("\n    Janky frames: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("35335")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("42.99")]),t._v("%"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#丢帧率")]),t._v("\n    90th percentile: 34ms\n    95th percentile: 42ms\n    99th percentile: 69ms\n    Number Missed Vsync: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4706")]),t._v("\n    Number High input latency: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("142")]),t._v("\n    Number Slow UI thread: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("17270")]),t._v("\n    Number Slow bitmap uploads: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1542")]),t._v("\n    Number Slow draw: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("23342")]),t._v("\n\n")])])]),s("br"),t._v(" "),s("ul",[s("li",[s("p",[t._v("参考")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://developer.android.com/training/testing/performance",target:"_blank",rel:"noopener noreferrer"}},[t._v("1. dumpsys"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("a",{attrs:{href:"http://blog.zhaiyifan.cn/2016/01/16/BlockCanaryTransparentPerformanceMonitor/",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.BlockCanary"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/seiginonakama/BlockCanaryEx",target:"_blank",rel:"noopener noreferrer"}},[t._v("3BlockCanaryEx"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/markzhai/AndroidPerformanceMonitor/blob/master/README_CN.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("4AndroidPerformanceMonitor"),s("OutboundLink")],1)])])])])}),[],!1,null,null,null);a.default=r.exports}}]);