<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>案例分析 | 知鱼之乐@Android</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="Just playing around 1">
    
    <link rel="preload" href="/assets/css/0.styles.4250c2dd.css" as="style"><link rel="preload" href="/assets/js/app.5b95a7b9.js" as="script"><link rel="preload" href="/assets/js/2.fdca36f3.js" as="script"><link rel="preload" href="/assets/js/49.437e04f0.js" as="script"><link rel="prefetch" href="/assets/js/10.b6f66bd7.js"><link rel="prefetch" href="/assets/js/100.2bae9e1d.js"><link rel="prefetch" href="/assets/js/101.486b1117.js"><link rel="prefetch" href="/assets/js/102.b0649886.js"><link rel="prefetch" href="/assets/js/103.920a731c.js"><link rel="prefetch" href="/assets/js/104.8c2bc020.js"><link rel="prefetch" href="/assets/js/105.017b3a95.js"><link rel="prefetch" href="/assets/js/106.b07d629e.js"><link rel="prefetch" href="/assets/js/107.9ebcb009.js"><link rel="prefetch" href="/assets/js/108.82b68e58.js"><link rel="prefetch" href="/assets/js/109.187d2211.js"><link rel="prefetch" href="/assets/js/11.1cdff8f2.js"><link rel="prefetch" href="/assets/js/110.c00bdf43.js"><link rel="prefetch" href="/assets/js/111.4c2deb04.js"><link rel="prefetch" href="/assets/js/112.c9247d04.js"><link rel="prefetch" href="/assets/js/113.7f8a35a8.js"><link rel="prefetch" href="/assets/js/114.f1821c8c.js"><link rel="prefetch" href="/assets/js/115.da61adae.js"><link rel="prefetch" href="/assets/js/116.031c6f2a.js"><link rel="prefetch" href="/assets/js/117.48669fe1.js"><link rel="prefetch" href="/assets/js/118.2f12c546.js"><link rel="prefetch" href="/assets/js/119.d2cafe5f.js"><link rel="prefetch" href="/assets/js/12.fdff2e95.js"><link rel="prefetch" href="/assets/js/120.61846920.js"><link rel="prefetch" href="/assets/js/121.8b3b50f0.js"><link rel="prefetch" href="/assets/js/122.ca476742.js"><link rel="prefetch" href="/assets/js/123.34aff44f.js"><link rel="prefetch" href="/assets/js/124.e9c45d41.js"><link rel="prefetch" href="/assets/js/13.4a38484b.js"><link rel="prefetch" href="/assets/js/14.1c279003.js"><link rel="prefetch" href="/assets/js/15.318899ac.js"><link rel="prefetch" href="/assets/js/16.668ab99f.js"><link rel="prefetch" href="/assets/js/17.403ba4f0.js"><link rel="prefetch" href="/assets/js/18.c40338e5.js"><link rel="prefetch" href="/assets/js/19.6c2ab8c8.js"><link rel="prefetch" href="/assets/js/20.232cc9e7.js"><link rel="prefetch" href="/assets/js/21.0eae87f2.js"><link rel="prefetch" href="/assets/js/22.ee7d3fc9.js"><link rel="prefetch" href="/assets/js/23.a6ebe3c8.js"><link rel="prefetch" href="/assets/js/24.c2027d50.js"><link rel="prefetch" href="/assets/js/25.4d01832f.js"><link rel="prefetch" href="/assets/js/26.49af490f.js"><link rel="prefetch" href="/assets/js/27.771d89bf.js"><link rel="prefetch" href="/assets/js/28.1d82e339.js"><link rel="prefetch" href="/assets/js/29.d3671768.js"><link rel="prefetch" href="/assets/js/3.5138c16a.js"><link rel="prefetch" href="/assets/js/30.b6ec07c0.js"><link rel="prefetch" href="/assets/js/31.e910587e.js"><link rel="prefetch" href="/assets/js/32.31d3db46.js"><link rel="prefetch" href="/assets/js/33.cdf8db27.js"><link rel="prefetch" href="/assets/js/34.b6c6ec0c.js"><link rel="prefetch" href="/assets/js/35.98f23494.js"><link rel="prefetch" href="/assets/js/36.6a085b9a.js"><link rel="prefetch" href="/assets/js/37.ab588e9a.js"><link rel="prefetch" href="/assets/js/38.502e585c.js"><link rel="prefetch" href="/assets/js/39.bceca364.js"><link rel="prefetch" href="/assets/js/4.6d9f636e.js"><link rel="prefetch" href="/assets/js/40.dcbff226.js"><link rel="prefetch" href="/assets/js/41.da6fa802.js"><link rel="prefetch" href="/assets/js/42.41d3285f.js"><link rel="prefetch" href="/assets/js/43.cdf3abfc.js"><link rel="prefetch" href="/assets/js/44.5c25470b.js"><link rel="prefetch" href="/assets/js/45.a807994a.js"><link rel="prefetch" href="/assets/js/46.b46567fd.js"><link rel="prefetch" href="/assets/js/47.fbb7d99b.js"><link rel="prefetch" href="/assets/js/48.d2dda935.js"><link rel="prefetch" href="/assets/js/5.9c6cd19b.js"><link rel="prefetch" href="/assets/js/50.7ea74e71.js"><link rel="prefetch" href="/assets/js/51.42cf3453.js"><link rel="prefetch" href="/assets/js/52.d8131e80.js"><link rel="prefetch" href="/assets/js/53.a21244c3.js"><link rel="prefetch" href="/assets/js/54.a02c86c6.js"><link rel="prefetch" href="/assets/js/55.0766f7a0.js"><link rel="prefetch" href="/assets/js/56.14cade1e.js"><link rel="prefetch" href="/assets/js/57.37388c10.js"><link rel="prefetch" href="/assets/js/58.8a2b0a8d.js"><link rel="prefetch" href="/assets/js/59.e5020649.js"><link rel="prefetch" href="/assets/js/6.222fe4b1.js"><link rel="prefetch" href="/assets/js/60.785e5ce4.js"><link rel="prefetch" href="/assets/js/61.7ff3727f.js"><link rel="prefetch" href="/assets/js/62.4413e1d6.js"><link rel="prefetch" href="/assets/js/63.d80f202c.js"><link rel="prefetch" href="/assets/js/64.3aa6f95a.js"><link rel="prefetch" href="/assets/js/65.91830885.js"><link rel="prefetch" href="/assets/js/66.fa26e91b.js"><link rel="prefetch" href="/assets/js/67.1aba5981.js"><link rel="prefetch" href="/assets/js/68.ea9e69d3.js"><link rel="prefetch" href="/assets/js/69.bd432e41.js"><link rel="prefetch" href="/assets/js/7.50e53555.js"><link rel="prefetch" href="/assets/js/70.10558a57.js"><link rel="prefetch" href="/assets/js/71.931a4e55.js"><link rel="prefetch" href="/assets/js/72.6b1e66db.js"><link rel="prefetch" href="/assets/js/73.fde8b627.js"><link rel="prefetch" href="/assets/js/74.d187c359.js"><link rel="prefetch" href="/assets/js/75.e320889d.js"><link rel="prefetch" href="/assets/js/76.5f956d12.js"><link rel="prefetch" href="/assets/js/77.7f0a0b47.js"><link rel="prefetch" href="/assets/js/78.7d2b004c.js"><link rel="prefetch" href="/assets/js/79.7b9a2bfe.js"><link rel="prefetch" href="/assets/js/8.8a987c8e.js"><link rel="prefetch" href="/assets/js/80.ba0f3691.js"><link rel="prefetch" href="/assets/js/81.85d8f665.js"><link rel="prefetch" href="/assets/js/82.906f4479.js"><link rel="prefetch" href="/assets/js/83.918b665e.js"><link rel="prefetch" href="/assets/js/84.69b25163.js"><link rel="prefetch" href="/assets/js/85.2bd518fd.js"><link rel="prefetch" href="/assets/js/86.3f54c198.js"><link rel="prefetch" href="/assets/js/87.8506a3cc.js"><link rel="prefetch" href="/assets/js/88.7c6d9727.js"><link rel="prefetch" href="/assets/js/89.24a60c90.js"><link rel="prefetch" href="/assets/js/9.abe89bc8.js"><link rel="prefetch" href="/assets/js/90.b20b4311.js"><link rel="prefetch" href="/assets/js/91.d8f65108.js"><link rel="prefetch" href="/assets/js/92.b4c4203b.js"><link rel="prefetch" href="/assets/js/93.0c6df625.js"><link rel="prefetch" href="/assets/js/94.3a387803.js"><link rel="prefetch" href="/assets/js/95.f3bf499d.js"><link rel="prefetch" href="/assets/js/96.3b95ac2a.js"><link rel="prefetch" href="/assets/js/97.54c1ad8f.js"><link rel="prefetch" href="/assets/js/98.b025ed29.js"><link rel="prefetch" href="/assets/js/99.146e244d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4250c2dd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">知鱼之乐@Android</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Android基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Android/01基础机制/1.Android系统启动流程.html" class="sidebar-link">Android系统启动过程</a></li><li><a href="/Android/01基础机制/2.Binder进程通信机制.html" class="sidebar-link">Binder进程通信机制</a></li><li><a href="/Android/07面试题/1.面试题-计算机基础.html" class="sidebar-link">1面试题-计算机基础</a></li><li><a href="/Android/07面试题/2.面试题-Android.html" class="sidebar-link">2面试题-Android</a></li><li><a href="/Android/07面试题/3.面试题-架构设计.html" class="sidebar-link">3面试题-架构设计</a></li><li><a href="/Android/07面试题/4.面试-业务实战.html" class="sidebar-link">4面试-业务实战</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>操作系统等</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/操作系统等/C编译原理.html" class="sidebar-link">C++编译原理</a></li><li><a href="/操作系统等/Linux常用操作手册.html" class="sidebar-link">Linux操作手册</a></li><li><a href="/操作系统等/IOS.html" class="sidebar-link">IOS</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Tools</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Tools/1.Mac开发快捷键大全.html" class="sidebar-link">Mac开发快捷键大全</a></li><li><a href="/Tools/2.翻墙工具指南.html" class="sidebar-link">翻墙工具指南</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>投名状</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ppt/警世通言.html" class="sidebar-link">警世通言</a></li><li><a href="/ppt/1.阿里技术合伙人.html" class="sidebar-link">阿里技术</a></li><li><a href="/ppt/2.企业家-雷军.html" class="sidebar-link">企业家-雷军</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h4 id="案例分析"><a href="#案例分析" class="header-anchor">#</a> 案例分析</h4> <p>[TOC]</p> <h5 id="_1-进程间通讯binder机制"><a href="#_1-进程间通讯binder机制" class="header-anchor">#</a> 1. 进程间通讯Binder机制</h5> <h5 id="_2-launcher启动过程"><a href="#_2-launcher启动过程" class="header-anchor">#</a> 2. Launcher启动过程</h5> <p><img src="images/app_launch.png" alt="img"></p> <h6 id="activitythread"><a href="#activitythread" class="header-anchor">#</a> ActivityThread</h6> <p>​	是主线程或UI线程，main方法是app的入口。</p> <div class="language- extra-class"><pre class="language-text"><code> //ActivityThread的main方法
    public static void main(String[] args) {
        ...
        Looper.prepareMainLooper();
        ActivityThread thread = new ActivityThread();
        //在attach方法中会完成Application对象的初始化，然后调用Application的onCreate()方法
        thread.attach(false);

        if (sMainThreadHandler == null) {
            sMainThreadHandler = thread.getHandler();
        }
        ...
        Looper.loop();
        throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);
    }
</code></pre></div><p>1 点击桌面APP图标时，Launcher的startActivity()方法，通过Binder通信，调用system_server进程中AMS服务的startActivity方法，发起启动请求</p> <p>2 system_server进程接收到请求后，向Zygote进程发送创建进程的请求</p> <p>3 Zygote进程fork出App进程，并执行ActivityThread的main方法，创建ActivityThread线程，初始化MainLooper，主线程Handler，同时初始化ApplicationThread用于和AMS通信交互</p> <p>4 App进程，通过Binder向sytem_server进程发起attachApplication请求，这里实际上就是APP进程通过Binder调用sytem_server进程中AMS的attachApplication方法，上面我们已经分析过，AMS的attachApplication方法的作用是将ApplicationThread对象与AMS绑定</p> <p>5 system_server进程在收到attachApplication的请求，进行一些准备工作后，再通过binder IPC向App进程发送handleBindApplication请求（初始化Application并调用onCreate方法）和scheduleLaunchActivity请求（创建启动Activity）</p> <p>6 App进程的binder线程（ApplicationThread）在收到请求后，通过handler向主线程发送BIND_APPLICATION和LAUNCH_ACTIVITY消息，这里注意的是AMS和主线程并不直接通信，而是AMS和主线程的内部类ApplicationThread通过Binder通信，ApplicationThread再和主线程通过Handler消息交互。 ( 这里猜测这样的设计意图可能是为了统一管理主线程与AMS的通信，并且不向AMS暴露主线程中的其他公开方法，大神可以来解析下)</p> <p>7 主线程在收到Message后，创建Application并调用onCreate方法，再通过反射机制创建目标Activity，并回调Activity.onCreate()等方法</p> <p>8 到此，App便正式启动，开始进入Activity生命周期，执行完onCreate/onStart/onResume方法，UI渲染后显示APP主界面。</p> <p>通过attach方法，实现与ActivityServiceMananger之间的绑定，使用Binder通讯。而AMS与Zygote之间是通过Socket通信。</p> <h5 id="_1-datepicker控件"><a href="#_1-datepicker控件" class="header-anchor">#</a> 1. DatePicker控件</h5> <h6 id="设计思想"><a href="#设计思想" class="header-anchor">#</a> 设计思想</h6> <ul><li><p>自定义控件</p> <p>通过自定义DataPicker类对xml进行封装，<code>使用简单、可进行UI定制。</code></p></li> <li><p>委托设计模式(Delegate)</p> <blockquote><p>委托模式：接受请求的对象将请求委托给另一个对象来处理。</p> <p>三要素：事件、事件接受者、事件委托者；</p> <p>两种方式： 直接委托、<strong>接口委托</strong>。</p> <p>优势： 隐藏实现细节，方便复用，容易扩展，松耦合,用<strong>聚合</strong>来替代<strong>继承</strong>。</p></blockquote> <p>DatePicker利用DatePickerSpinnerDelegate类实现UI细节。</p></li></ul> <h6 id="分析"><a href="#分析" class="header-anchor">#</a> 分析</h6> <p>利用接口代理方式，将实现细节封装到另一个类。<code>就算以后UI实现类变了也不影响上层代码。</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * DataPicker 控件
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataPicker</span> <span class="token keyword">extends</span> <span class="token class-name">FrameLayout</span><span class="token punctuation">{</span>
  <span class="token comment">//1. 委托者(接口)，定义委托事件</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DatePickerDelegate</span> mDelegate<span class="token punctuation">;</span>
  <span class="token comment">// 通过委托处理事件</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> mDelegate<span class="token punctuation">.</span><span class="token function">getYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">//2. 委托接口</span>
  <span class="token keyword">interface</span> <span class="token class-name">DatePickerDelegate</span><span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> year<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">getYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * DatePickerSpinnerDelegate 委托者
 */</span>
<span class="token keyword">class</span> <span class="token class-name">DatePickerSpinnerDelegate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractDatePickerDelegate</span> <span class="token punctuation">{</span>
  <span class="token class-name">DatePickerSpinnerDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 初始化xml</span>
    <span class="token keyword">final</span> <span class="token class-name">View</span> view <span class="token operator">=</span> inflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>date_picker_legacy<span class="token punctuation">,</span> mDelegator<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    view<span class="token punctuation">.</span><span class="token function">setSaveFromParentEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">2020</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre></div><h5 id="_2-android-ui基本概念梳理"><a href="#_2-android-ui基本概念梳理" class="header-anchor">#</a> 2.Android UI基本概念梳理</h5> <h6 id="_1-window"><a href="#_1-window" class="header-anchor">#</a> 1. Window</h6> <p>​	Window是一个抽象类，具体实现是PhoneWindow。Android中所以的视图都是通过Window来呈现的。</p> <p><code>每一个Window对应一个DecorView和ViewRootImpl</code>,Window和View通过ViewRootImpl来建立联系，Window并不是实际存在的，View才是Window存在的实体(View不能单独存在，必须依附在Window上)。</p> <h6 id="_2-window和windowmanager"><a href="#_2-window和windowmanager" class="header-anchor">#</a> 2. Window和WindowManager</h6> <p>​	<strong>WindowManager是外界访问Window的入口，</strong> WindowManager继承ViewManager，常用的有三个功能：</p> <ul><li>创建一个Window并增加View(addView)；</li> <li>更新Window中的View；</li> <li>删除一个View；</li></ul> <h6 id="_3-window的创建过程"><a href="#_3-window的创建过程" class="header-anchor">#</a> 3. Window的创建过程</h6> <p>​	ActivityThread中的<code>performLaunchActivity()</code>来完成启动过程，并调用<code>attach</code>方法，在<code>attach</code>中完成PhoneWindow的创建：</p> <p><code>mWindow = new PhoneWindow(this, window, activityConfigCallback);</code></p> <h6 id="_4-decorview"><a href="#_4-decorview" class="header-anchor">#</a> 4. DecorView</h6> <p>​	DecorView是一个FrameLayout，是Activity中顶级View，一般包括标题栏和内容栏，但随着主题的变化而变化；内容栏是一定存在的，完整的id为android.R.id.content;在Activity中的setContentView设置布局文件。</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token keyword">int</span> layoutResID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果mContentParent为空，就去创建一个DecorView</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mContentParent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">installDecor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasFeature</span><span class="token punctuation">(</span>FEATURE_CONTENT_TRANSITIONS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果不为空，就删除其中的View</span>
            mContentParent<span class="token punctuation">.</span><span class="token function">removeAllViews</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasFeature</span><span class="token punctuation">(</span>FEATURE_CONTENT_TRANSITIONS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Scene</span> newScene <span class="token operator">=</span> <span class="token class-name">Scene</span><span class="token punctuation">.</span><span class="token function">getSceneForLayout</span><span class="token punctuation">(</span>mContentParent<span class="token punctuation">,</span> layoutResID<span class="token punctuation">,</span>
                    <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">transitionTo</span><span class="token punctuation">(</span>newScene<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//把布局文件添加到mContentParent中</span>
            mLayoutInflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>layoutResID<span class="token punctuation">,</span> mContentParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mContentParent<span class="token punctuation">.</span><span class="token function">requestApplyInsets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Callback</span> cb <span class="token operator">=</span> <span class="token function">getCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cb <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//回调通知，内容发生改变了</span>
            cb<span class="token punctuation">.</span><span class="token function">onContentChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mContentParentExplicitlySet <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 生成DecorView</span>
<span class="token keyword">protected</span> <span class="token class-name">DecorView</span> <span class="token function">generateDecor</span><span class="token punctuation">(</span><span class="token keyword">int</span> featureId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DecorView</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> featureId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的mContentParent实际上是前面提到的id为content的FrameLayout.</p> <p>​	而generateLayout()主要就是先获取主题的样式，然后根据样式加载对应的布局到DecorView中，然后再获取mContentParent并返回，就可以把布局文件添加到mContentParent中了，即Activity所需要展示的布局.
到这为止，Activity的布局文件已经成功添加到了DecorView的mContentParent中，<strong>但是DecorView还没有被WindowManager添加到Window中，即用户还不能看到视图.！！！</strong></p> <h6 id="_5-decorview的展示"><a href="#_5-decorview的展示" class="header-anchor">#</a> 5. DecorView的展示</h6> <p>​	在ActivityThread的<code>handleResumeActivity</code>方法中，会首先调用Activity的onResume方法，接着调用Activity的<strong>makeVisible()</strong>:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">makeVisible</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mWindowAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ViewManager</span> wm <span class="token operator">=</span> <span class="token function">getWindowManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wm<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>mDecor<span class="token punctuation">,</span> <span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mWindowAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  mDecor<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span>VISIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到此DecorView真正完成添加和显示两个过程，视图可见了。</p> <p>​	我们来看下addView方法，WindowManager是个接口，具体实现类是WindowManagerImpl：</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">ViewGroup<span class="token punctuation">.</span>LayoutParams</span> params<span class="token punctuation">,</span>
            <span class="token class-name">Display</span> display<span class="token punctuation">,</span> <span class="token class-name">Window</span> parentWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">ViewRootImpl</span> root<span class="token punctuation">;</span>
        root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewRootImpl</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> display<span class="token punctuation">)</span><span class="token punctuation">;</span>
        view<span class="token punctuation">.</span><span class="token function">setLayoutParams</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mViews<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mRoots<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mParams<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
       	  <span class="token comment">//将DecorView交给ViewRootImpl</span>
          root<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> wparams<span class="token punctuation">,</span> panelParentView<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这是实例化了<strong>ViewRootImpl</strong>对象，然后调用<code>setView</code>方法，经过一系列处理后最终调用<code>performTraversals()</code>方法，开始进行View的measure、layout、draw，把界面显示出来。</p> <h6 id="_6-viewroot"><a href="#_6-viewroot" class="header-anchor">#</a> 6. ViewRoot</h6> <p>​	ViewRoot对应于ViewRootImpl类(不真实存在)，是连接<strong>DecorView</strong>和<strong>WindowManager</strong>的纽带，View的三大流程操作都是有ViewRoot完成。在ActivityThread中，Activity对象创建成功后，会将DecorView添加到Window中，并创建ViewRootImpl对象，并将DecorView和ViewRootImpl进行关联。</p> <p>​	<code>ViewRootImpl负责和WMS通讯，和WMS通讯的AIDL WindowSession虽然不是ViewRootImpl自己创建的，但是WindowManagerGlobal在和WMS联通之后，把WindowSession传递给了ViewRootImpl的。WMS和window通讯的AIDL IWindow也是ViewRootImpl创建的，可见ViewRootImpl是负责通讯的。</code></p> <p>​	<code>除了通信外，ViewRootImpl负责整个window窗口所有UI视图的Measure、Layout、Draw，ViewRootImpl.performTraversals()是整个视图树的起点。</code></p> <h6 id="_7-windowmanagerservice"><a href="#_7-windowmanagerservice" class="header-anchor">#</a> 7. WindowManagerService</h6> <p>​	运作在Android系统自己的进程中，用于屏幕显示的逻辑控制，Window只是持有每个Activity的UI内容，但是如何显示，和其他Window如何交互，都是有WMS完成的。</p> <p>​	WMS中除了可以增加、删除Window外，还通过<strong>Z-order</strong>概念管理Window的负责关系，Z-order大的会覆盖在小的上面。利用他可以</p> <h6 id="_8-surface"><a href="#_8-surface" class="header-anchor">#</a> 8. Surface</h6> <blockquote><p>​	一个Surface就是一个对象，该对象持有一群像素（pixels），这些像素是要被组合到一起显示到屏幕上的。你在手机屏幕上看到的每一个window（如对话框、全屏的activity、状态栏）都有唯一一个自己的surface，window将自己的内容（content）绘制到该surface中。Surface Flinger根据各个surface在Z轴上的顺序（Z-order）将它们渲染到最终的显示屏上。</p> <p>​	另一种解释：在Android系统中，窗口是独占一个Surface实例的显示区域，每个窗口的Surface由WindowManagerService分配。我们可以把Surface看作一块画布，应用可以通过Canvas或OpenGL在其上面作画。画好之后，通过SurfaceFlinger将多块Surface按照特定的顺序（即Z-order）进行混合，而后输出到FrameBuffer中，这样用户界面就得以显示。</p></blockquote> <p>​	其中，SurfaceFlinger是Android一个服务进程，负责管理Surface。</p> <h5 id="_3-androidui视图结构"><a href="#_3-androidui视图结构" class="header-anchor">#</a> 3. AndroidUI视图结构</h5> <p><img src="images/ui_act_decor_window_diff.png" alt="ppt_ui"></p> <h6 id="设计思想-2"><a href="#设计思想-2" class="header-anchor">#</a> 设计思想</h6> <h6 id="分析-2"><a href="#分析-2" class="header-anchor">#</a> 分析</h6> <ol><li><p><strong>一个Activity对应一个Window</strong></p> <p>Activity并不负责视图控制，它只控制生命周期和处理事件。真正控制视图的事Window。一个Activity包含一个Window，在attach()方法中创建。</p></li> <li><p><strong>一个PhoneWindow持有一个DecorView实例</strong></p> <p>Window内部持有一个DecorView，而这个DecorView才是View的根布局；</p> <p>Window是一个抽象类，PhoneWinow是实现类。通过创建DecorView来加载用户布局；</p> <p>Window通过WindowManager将DecorView加载其中，并将DecorView交给ViewRoot，进行视图绘制和其他交互。</p></li> <li><p><strong>DecorView</strong></p> <p>DecorView是FrameLayout的子类，是Android的根视图节点；</p> <p>一般情况包含一个竖向的LinearLayout，<strong>它包含上中下三部分，上面是ViewStub,延迟加载的视图(根据Theme的ActionBar)，中间是标题栏，下面是内容栏。</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 具体实现与Android版本有关</span>
<span class="token operator">&lt;</span><span class="token class-name">LinearLayout</span> xmlns<span class="token operator">:</span>android<span class="token operator">=</span><span class="token string">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    android<span class="token operator">:</span>fitsSystemWindows<span class="token operator">=</span><span class="token string">&quot;true&quot;</span>
    android<span class="token operator">:</span>orientation<span class="token operator">=</span><span class="token string">&quot;vertical&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token class-name">Popout</span> bar <span class="token keyword">for</span> action modes <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token class-name">ViewStub</span>
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">&quot;@+id/action_mode_bar_stub&quot;</span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">&quot;wrap_content&quot;</span>
        android<span class="token operator">:</span>inflatedId<span class="token operator">=</span><span class="token string">&quot;@+id/action_mode_bar&quot;</span>
        android<span class="token operator">:</span>layout<span class="token operator">=</span><span class="token string">&quot;@layout/action_mode_bar&quot;</span>
        android<span class="token operator">:</span>theme<span class="token operator">=</span><span class="token string">&quot;?attr/actionBarTheme&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token class-name">FrameLayout</span>
        style<span class="token operator">=</span><span class="token string">&quot;?android:attr/windowTitleBackgroundStyle&quot;</span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">&quot;?android:attr/windowTitleSize&quot;</span><span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span><span class="token class-name">TextView</span>
            android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">&quot;@android:id/title&quot;</span>
            style<span class="token operator">=</span><span class="token string">&quot;?android:attr/windowTitleStyle&quot;</span>
            android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span>
            android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span>
            android<span class="token operator">:</span>background<span class="token operator">=</span><span class="token string">&quot;@null&quot;</span>
            android<span class="token operator">:</span>fadingEdge<span class="token operator">=</span><span class="token string">&quot;horizontal&quot;</span>
            android<span class="token operator">:</span>gravity<span class="token operator">=</span><span class="token string">&quot;center_vertical&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token class-name">FrameLayout</span><span class="token operator">&gt;</span>

		<span class="token comment">// Activity中用户的自定义布局加载到 content中！！！</span>
    <span class="token operator">&lt;</span><span class="token class-name">FrameLayout</span>
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">&quot;@android:id/content&quot;</span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">&quot;0dip&quot;</span>
        android<span class="token operator">:</span>layout_weight<span class="token operator">=</span><span class="token string">&quot;1&quot;</span>
        android<span class="token operator">:</span>foreground<span class="token operator">=</span><span class="token string">&quot;?android:attr/windowContentOverlay&quot;</span>
        android<span class="token operator">:</span>foregroundGravity<span class="token operator">=</span><span class="token string">&quot;fill_horizontal|top&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token class-name">LinearLayout</span><span class="token operator">&gt;</span>
</code></pre></div></li></ol> <h5 id="_4-android-ui-window显示过程"><a href="#_4-android-ui-window显示过程" class="header-anchor">#</a> 4. Android UI Window显示过程</h5> <p><a href="https://www.cnblogs.com/samchen2009/category/524173.html" target="_blank" rel="noopener noreferrer">GUI系统<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.cnblogs.com/blogs-of-lxl/p/11443693.html" target="_blank" rel="noopener noreferrer">VSYNC设计<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://www.360doc.com/content/18/0328/15/7377734_740892969.shtml" target="_blank" rel="noopener noreferrer">Surface&amp;SurfaceFlinger关系<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h6 id="设计思路"><a href="#设计思路" class="header-anchor">#</a> 设计思路</h6> <p><img src="images/UI_show_wms_viewroot_aidl.png" alt="ui_aidl"></p> <p>​	ViewRootImpl持有与WMS通讯的AIDL WindowSession，WMS持有与ViewRootImp通讯的AIDL IWindow，这个IWindow也是ViewRootImpl注册到WMS里面的。</p> <p>​	<img src="images/ui_window_create.png" alt="ui_window_create"></p> <h6 id="分析-3"><a href="#分析-3" class="header-anchor">#</a> 分析</h6> <ul><li><p>涉及类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
	* ViewManager 添加、删除、更新View
	*/</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ViewManager</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">ViewGroup<span class="token punctuation">.</span>LayoutParams</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateViewLayout</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">ViewGroup<span class="token punctuation">.</span>LayoutParams</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
	* ViewParent 父View交互API
	*/</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ViewParent</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 导致View的onMeasure、onLayout、onDraw方法被调用</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
	* ViewGroup
	*/</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ViewGroup</span> <span class="token keyword">extends</span> <span class="token class-name">View</span> <span class="token keyword">implements</span> <span class="token class-name">ViewParent</span><span class="token punctuation">,</span> <span class="token class-name">ViewManager</span> <span class="token punctuation">{</span>
  <span class="token comment">// Child views of this ViewGroup</span>
  <span class="token keyword">private</span> <span class="token class-name">View</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mChildren<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> mChildrenCount<span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addView</span><span class="token punctuation">(</span><span class="token class-name">View</span> child<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">LayoutParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// addViewInner() will call child.requestLayout() when setting the new LayoutParams</span>
    <span class="token comment">// therefore, we call requestLayout() on ourselves before, so that the child's request</span>
    <span class="token comment">// will be blocked at our level</span>
    <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addViewInner</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> index<span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>WindowManagerImpl实现了WindowManager接口：</strong></p> <blockquote><p>注意：</p> <p>不管是<code>WindowManagerImpl</code>还是ViewGroup的addView(View view, ViewGroup.LayoutParams params)方法都是来自于<code>ViewManager</code>接口，但是在ViewGroup中是将普通的view或者ViewGroup作为Children加入，但是在<code>WindowManagerImpl</code>是将<code>DecorView</code>作为根布局加入到PhoneWindow中去，虽然都是基于同一个<code>ViewManager</code>接口，但是起作用截然不同.</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// windown交互管理类</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WindowManagerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">WindowManager</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">WindowManagerGlobal</span> mGlobal <span class="token operator">=</span> <span class="token class-name">WindowManagerGlobal</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ViewGroup<span class="token punctuation">.</span>LayoutParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">applyDefaultToken</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mGlobal<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> params<span class="token punctuation">,</span> mContext<span class="token punctuation">.</span><span class="token function">getDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mParentWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// 单例window全局管理类</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WindowManagerGlobal</span> <span class="token punctuation">{</span>
  	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">WindowManagerGlobal</span> sDefaultWindowManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">IWindowManager</span> sWindowManagerService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">IWindowSession</span> sWindowSession<span class="token punctuation">;</span>
		<span class="token comment">// 存储viewList,ViewRootImplList.</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">View</span><span class="token punctuation">&gt;</span></span> mViews <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">View</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">&gt;</span></span> mRoots <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">&gt;</span></span> mParams <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">View</span><span class="token punctuation">&gt;</span></span> mDyingViews <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">View</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  	<span class="token comment">// viewrootimpl创建</span>
  	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">ViewGroup<span class="token punctuation">.</span>LayoutParams</span> params<span class="token punctuation">,</span>
            <span class="token class-name">Display</span> display<span class="token punctuation">,</span> <span class="token class-name">Window</span> parentWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span>  	
    	<span class="token class-name">ViewRootImpl</span> root<span class="token punctuation">;</span>
      <span class="token class-name">View</span> panelParentView <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
     	<span class="token comment">// begin	</span>
      root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewRootImpl</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> display<span class="token punctuation">)</span><span class="token punctuation">;</span>
      view<span class="token punctuation">.</span><span class="token function">setLayoutParams</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 保存到List</span>
      mViews<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mRoots<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mParams<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// do this last because it fires off messages to start doing things</span>
      root<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> wparams<span class="token punctuation">,</span> panelParentView<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// viewRootImpl通信类</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ViewRootImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ViewParent</span><span class="token punctuation">,</span>
        <span class="token class-name">View<span class="token punctuation">.</span>AttachInfo<span class="token punctuation">.</span>Callbacks</span><span class="token punctuation">,</span> <span class="token class-name">ThreadedRenderer<span class="token punctuation">.</span>DrawCallbacks</span> <span class="token punctuation">{</span>
    <span class="token comment">// 与WMS通信接口</span>
    <span class="token keyword">final</span> <span class="token class-name">IWindowSession</span> mWindowSession<span class="token punctuation">;</span>
    <span class="token comment">// 显示类</span>
    <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Display</span> mDisplay<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">DisplayManager</span> mDisplayManager<span class="token punctuation">;</span>      

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span> attrs<span class="token punctuation">,</span> <span class="token class-name">View</span> panelParentView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token comment">// Schedule the first layout -before- adding to the window</span>
      <span class="token comment">// manager, to make sure we do the relayout before receiving</span>
      <span class="token comment">// any other events from the system.</span>
      <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 1.触发绘制流程 </span>
      <span class="token comment">// 通信WMS添加显示view  2. 通过IPC 执行WMS.addWindow方法。</span>
      <span class="token comment">// 通过WindowSession进行IPC调用，将View添加到Window上</span>
      <span class="token comment">// mWindow即W类，用来接收WMS信息；同时通过InputChannel接收触摸事件回调。</span>
      res <span class="token operator">=</span> mWindowSession<span class="token punctuation">.</span><span class="token function">addToDisplay</span><span class="token punctuation">(</span>mWindow<span class="token punctuation">,</span> mSeq<span class="token punctuation">,</span> mWindowAttributes<span class="token punctuation">,</span>
                            <span class="token function">getHostVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mDisplay<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            mAttachInfo<span class="token punctuation">.</span>mContentInsets<span class="token punctuation">,</span> mAttachInfo<span class="token punctuation">.</span>mStableInsets<span class="token punctuation">,</span>
                            mAttachInfo<span class="token punctuation">.</span>mOutsets<span class="token punctuation">,</span> mInputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
          
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHandlingLayoutInLayoutRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mLayoutRequested <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">scheduleTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 遍历View进行测量计算(2次执行)      </span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cancelDraw <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newSurface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingTransitions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mPendingTransitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mPendingTransitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mPendingTransitions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startChangingAnimations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mPendingTransitions<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// draw</span>
            <span class="token function">performDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isViewVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Try again！！！</span>
                <span class="token function">scheduleTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingTransitions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mPendingTransitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mPendingTransitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mPendingTransitions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endChangingAnimations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mPendingTransitions<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>           
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><strong>addToDisplay</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">addToDisplay</span><span class="token punctuation">(</span><span class="token class-name">IWindow</span> window<span class="token punctuation">,</span> <span class="token keyword">int</span> seq<span class="token punctuation">,</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span> attrs<span class="token punctuation">,</span>
                <span class="token keyword">int</span> viewVisibility<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">,</span> <span class="token class-name">Rect</span> outContentInsets<span class="token punctuation">,</span> <span class="token class-name">Rect</span> outStableInsets<span class="token punctuation">,</span>
                <span class="token class-name">Rect</span> outOutsets<span class="token punctuation">,</span> <span class="token class-name">InputChannel</span> outInputChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mService<span class="token punctuation">.</span><span class="token function">addWindow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> window<span class="token punctuation">,</span> seq<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> viewVisibility<span class="token punctuation">,</span> displayId<span class="token punctuation">,</span>
                    outContentInsets<span class="token punctuation">,</span> outStableInsets<span class="token punctuation">,</span> outOutsets<span class="token punctuation">,</span> outInputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>​	注意，addToDisplay是在WMS系统进程中执行的。</p> <p>简单总结下Activity启动后布局显示过程：</p> <ol><li>SurfaceFlinger 是在init.rc解析的时候被创建的，执行其main方法，实例化了Surfaceflinger，并向ServiceManager注册，SurfaceFlinger运行在单独进程中。</li> <li>在 Activity 创建过程中执行 scheduleLaunchActivity() 之后便调用到了 handleLaunchActivity() 方法。首先通过Instrumentation创建Activity，然后执行Activity的attach()方法，创建 PhoneWindow，且与activity建立回调关联。获取WindowManager，层层代理最终干活的是WindowManagerGlobal。</li> <li>setContentView过程，创建DecorView，并把xml的View树解析出来，加到DecorView上的contentParent部分。</li> <li>Activity 调用makeVisible ，实际上是WindowManagerGlobal执行addView操作，然后调用ViewRootImpl setView操作。</li> <li>ViewRootImpl setView 做了两件事： 1） requestLayout触发绘制流程 2）mWindowSession.addToDisplay 通过IPC 执行WMS.addWindow</li> <li>requestLayout ：中的relayoutWindow过程中app请求SurfaceFlinger创建Surface</li> <li>mWindowSession.addToDisplay：最终执行WMS.addWindow方法，该方法流程最终建立了app与SurfaceFlinger服务连接。</li> <li>Android应用程序与SurfaceFlinger服务是运行在不同的进程中的，用Binder进行通信，用匿名共享内存进行UI数据传递。</li> <li>requestLayout draw的流程中：Surface通过dequeueBuffer获取一块GraphicBuffer, 然后onDraw中通过传入的Java层Canvas 调用底层Skia引擎中的SKCanvas（画家）、SKBitmap（画布）进行具体绘制操作，绘制完成之后把图形数据放入GraphicBuffer，最后Surface执行queueBuffer，把这块带有图形数据的buffer送回BufferQueue,并通过onFrameAvailable通知Layer更新。</li> <li>SurfaceFlinger合成图层依赖于Android的异步消息处理机制，每16ms接收一次vsync信号来执行图层合成操作，最终通过handleMessageRefresh一系列方法的处理，其中包括把GraphicBuffer数据映射为OpenGL的texture ，收集所有Layer计算显示区域，然后通过openG 或 HWC进行合成以及栅格化处理，最后送显。</li></ol> <h5 id="_6-热修复原理"><a href="#_6-热修复原理" class="header-anchor">#</a> 6. 热修复原理？</h5> <p><a href="https://www.cnblogs.com/popfisher/p/8543973.html" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>代码修复主要有三个方案，分别是底层替换方案、类加载方案和Instant Run方案。</p></blockquote> <ul><li><p>类加载方案</p> <p>​	类加载方案基于Dex分包方案。65536限制的原因是DVM Bytecode的限制，DVM指令集的方法调用指令invoke-kind所以为16bits，最多能引用65535个方法。</p> <p><strong>Dex分包方案主要做的是在打包时将应用代码分成多个Dex，将应用启动时必须用到的类和这些类的直接引用类放到主Dex中，其他代码放到次Dex中。当应用启动时先加载主Dex，等到应用启动后再动态的加载次Dex，从而缓解了主Dex的65536限制和LinearAlloc限制。</strong></p></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//BaseDexClassLoader下有一个数组——DexPathList </span>
<span class="token comment">// libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span>
 <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span></span> suppressed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Element</span> element <span class="token operator">:</span> dexElements<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//1 变量查找dex数组</span>
            <span class="token comment">//2 找到对应clazz</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> definingContext<span class="token punctuation">,</span> suppressed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dexElementsSuppressedExceptions <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            suppressed<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>dexElementsSuppressedExceptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Element内部封装了DexFile，DexFile用于加载dex文件，因此每个dex文件对应一个Element。
多个Element组成了有序的Element数组dexElements。当要查找类时，会在注释1处遍历Element数组dexElements（相当于遍历dex文件数组），注释2处调用Element的findClass方法，其方法内部会调用DexFile的loadClassBinaryName方法查找类。如果在Element中（dex文件）找到了该类就返回，如果没有找到就接着在下一个Element中进行查找。
<code>根据上面的查找流程，我们将有bug的类Key.class进行修改，再将Key.class打包成包含dex的补丁包Patch.jar，放在Element数组dexElements的第一个元素，这样会首先找到Patch.dex中的Key.class去替换之前存在bug的Key.class，排在数组后面的dex文件中的存在bug的Key.class根据ClassLoader的双亲委托模式就不会被加载，这就是类加载方案。</code></p> <p>​	例如：微信Tinker将新旧apk做了diff，得到patch.dex，然后将patch.dex与手机中apk的classes.dex做合并，生成新的classes.dex，然后在运行时通过反射将classes.dex放在Element数组的第一个元素。</p> <ul><li><p>底层替换方案</p> <p>不会再次加载新类，而是直接在Native层修改原有的类。替换ArtMethod结构体中的字段或者替换整个ArtMethod结构体，这就是底层替换方案。</p></li> <li><p>instant run方案</p> <p>在第一次构建apk时，使用asm在每一个方法注入检查方法是否变更的代码。如果变更，执行新的方法。</p></li></ul> <h5 id="_7-windows的显示流程"><a href="#_7-windows的显示流程" class="header-anchor">#</a> 7. Windows的显示流程？</h5> <h5 id="_8-view的绘制流程"><a href="#_8-view的绘制流程" class="header-anchor">#</a> 8. View的绘制流程？</h5></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5b95a7b9.js" defer></script><script src="/assets/js/2.fdca36f3.js" defer></script><script src="/assets/js/49.437e04f0.js" defer></script>
  </body>
</html>
