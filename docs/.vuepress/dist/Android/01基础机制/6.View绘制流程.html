<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>View绘制流程 | 知鱼之乐@Android</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="Just playing around 1">
    
    <link rel="preload" href="/assets/css/0.styles.4250c2dd.css" as="style"><link rel="preload" href="/assets/js/app.5b95a7b9.js" as="script"><link rel="preload" href="/assets/js/2.fdca36f3.js" as="script"><link rel="preload" href="/assets/js/25.4d01832f.js" as="script"><link rel="prefetch" href="/assets/js/10.b6f66bd7.js"><link rel="prefetch" href="/assets/js/100.2bae9e1d.js"><link rel="prefetch" href="/assets/js/101.486b1117.js"><link rel="prefetch" href="/assets/js/102.b0649886.js"><link rel="prefetch" href="/assets/js/103.920a731c.js"><link rel="prefetch" href="/assets/js/104.8c2bc020.js"><link rel="prefetch" href="/assets/js/105.017b3a95.js"><link rel="prefetch" href="/assets/js/106.b07d629e.js"><link rel="prefetch" href="/assets/js/107.9ebcb009.js"><link rel="prefetch" href="/assets/js/108.82b68e58.js"><link rel="prefetch" href="/assets/js/109.187d2211.js"><link rel="prefetch" href="/assets/js/11.1cdff8f2.js"><link rel="prefetch" href="/assets/js/110.c00bdf43.js"><link rel="prefetch" href="/assets/js/111.4c2deb04.js"><link rel="prefetch" href="/assets/js/112.c9247d04.js"><link rel="prefetch" href="/assets/js/113.7f8a35a8.js"><link rel="prefetch" href="/assets/js/114.f1821c8c.js"><link rel="prefetch" href="/assets/js/115.da61adae.js"><link rel="prefetch" href="/assets/js/116.031c6f2a.js"><link rel="prefetch" href="/assets/js/117.48669fe1.js"><link rel="prefetch" href="/assets/js/118.2f12c546.js"><link rel="prefetch" href="/assets/js/119.d2cafe5f.js"><link rel="prefetch" href="/assets/js/12.fdff2e95.js"><link rel="prefetch" href="/assets/js/120.61846920.js"><link rel="prefetch" href="/assets/js/121.8b3b50f0.js"><link rel="prefetch" href="/assets/js/122.ca476742.js"><link rel="prefetch" href="/assets/js/123.34aff44f.js"><link rel="prefetch" href="/assets/js/124.e9c45d41.js"><link rel="prefetch" href="/assets/js/13.4a38484b.js"><link rel="prefetch" href="/assets/js/14.1c279003.js"><link rel="prefetch" href="/assets/js/15.318899ac.js"><link rel="prefetch" href="/assets/js/16.668ab99f.js"><link rel="prefetch" href="/assets/js/17.403ba4f0.js"><link rel="prefetch" href="/assets/js/18.c40338e5.js"><link rel="prefetch" href="/assets/js/19.6c2ab8c8.js"><link rel="prefetch" href="/assets/js/20.232cc9e7.js"><link rel="prefetch" href="/assets/js/21.0eae87f2.js"><link rel="prefetch" href="/assets/js/22.ee7d3fc9.js"><link rel="prefetch" href="/assets/js/23.a6ebe3c8.js"><link rel="prefetch" href="/assets/js/24.c2027d50.js"><link rel="prefetch" href="/assets/js/26.49af490f.js"><link rel="prefetch" href="/assets/js/27.771d89bf.js"><link rel="prefetch" href="/assets/js/28.1d82e339.js"><link rel="prefetch" href="/assets/js/29.d3671768.js"><link rel="prefetch" href="/assets/js/3.5138c16a.js"><link rel="prefetch" href="/assets/js/30.b6ec07c0.js"><link rel="prefetch" href="/assets/js/31.e910587e.js"><link rel="prefetch" href="/assets/js/32.31d3db46.js"><link rel="prefetch" href="/assets/js/33.cdf8db27.js"><link rel="prefetch" href="/assets/js/34.b6c6ec0c.js"><link rel="prefetch" href="/assets/js/35.98f23494.js"><link rel="prefetch" href="/assets/js/36.6a085b9a.js"><link rel="prefetch" href="/assets/js/37.ab588e9a.js"><link rel="prefetch" href="/assets/js/38.502e585c.js"><link rel="prefetch" href="/assets/js/39.bceca364.js"><link rel="prefetch" href="/assets/js/4.6d9f636e.js"><link rel="prefetch" href="/assets/js/40.dcbff226.js"><link rel="prefetch" href="/assets/js/41.da6fa802.js"><link rel="prefetch" href="/assets/js/42.41d3285f.js"><link rel="prefetch" href="/assets/js/43.cdf3abfc.js"><link rel="prefetch" href="/assets/js/44.5c25470b.js"><link rel="prefetch" href="/assets/js/45.a807994a.js"><link rel="prefetch" href="/assets/js/46.b46567fd.js"><link rel="prefetch" href="/assets/js/47.fbb7d99b.js"><link rel="prefetch" href="/assets/js/48.d2dda935.js"><link rel="prefetch" href="/assets/js/49.437e04f0.js"><link rel="prefetch" href="/assets/js/5.9c6cd19b.js"><link rel="prefetch" href="/assets/js/50.7ea74e71.js"><link rel="prefetch" href="/assets/js/51.42cf3453.js"><link rel="prefetch" href="/assets/js/52.d8131e80.js"><link rel="prefetch" href="/assets/js/53.a21244c3.js"><link rel="prefetch" href="/assets/js/54.a02c86c6.js"><link rel="prefetch" href="/assets/js/55.0766f7a0.js"><link rel="prefetch" href="/assets/js/56.14cade1e.js"><link rel="prefetch" href="/assets/js/57.37388c10.js"><link rel="prefetch" href="/assets/js/58.8a2b0a8d.js"><link rel="prefetch" href="/assets/js/59.e5020649.js"><link rel="prefetch" href="/assets/js/6.222fe4b1.js"><link rel="prefetch" href="/assets/js/60.785e5ce4.js"><link rel="prefetch" href="/assets/js/61.7ff3727f.js"><link rel="prefetch" href="/assets/js/62.4413e1d6.js"><link rel="prefetch" href="/assets/js/63.d80f202c.js"><link rel="prefetch" href="/assets/js/64.3aa6f95a.js"><link rel="prefetch" href="/assets/js/65.91830885.js"><link rel="prefetch" href="/assets/js/66.fa26e91b.js"><link rel="prefetch" href="/assets/js/67.1aba5981.js"><link rel="prefetch" href="/assets/js/68.ea9e69d3.js"><link rel="prefetch" href="/assets/js/69.bd432e41.js"><link rel="prefetch" href="/assets/js/7.50e53555.js"><link rel="prefetch" href="/assets/js/70.10558a57.js"><link rel="prefetch" href="/assets/js/71.931a4e55.js"><link rel="prefetch" href="/assets/js/72.6b1e66db.js"><link rel="prefetch" href="/assets/js/73.fde8b627.js"><link rel="prefetch" href="/assets/js/74.d187c359.js"><link rel="prefetch" href="/assets/js/75.e320889d.js"><link rel="prefetch" href="/assets/js/76.5f956d12.js"><link rel="prefetch" href="/assets/js/77.7f0a0b47.js"><link rel="prefetch" href="/assets/js/78.7d2b004c.js"><link rel="prefetch" href="/assets/js/79.7b9a2bfe.js"><link rel="prefetch" href="/assets/js/8.8a987c8e.js"><link rel="prefetch" href="/assets/js/80.ba0f3691.js"><link rel="prefetch" href="/assets/js/81.85d8f665.js"><link rel="prefetch" href="/assets/js/82.906f4479.js"><link rel="prefetch" href="/assets/js/83.918b665e.js"><link rel="prefetch" href="/assets/js/84.69b25163.js"><link rel="prefetch" href="/assets/js/85.2bd518fd.js"><link rel="prefetch" href="/assets/js/86.3f54c198.js"><link rel="prefetch" href="/assets/js/87.8506a3cc.js"><link rel="prefetch" href="/assets/js/88.7c6d9727.js"><link rel="prefetch" href="/assets/js/89.24a60c90.js"><link rel="prefetch" href="/assets/js/9.abe89bc8.js"><link rel="prefetch" href="/assets/js/90.b20b4311.js"><link rel="prefetch" href="/assets/js/91.d8f65108.js"><link rel="prefetch" href="/assets/js/92.b4c4203b.js"><link rel="prefetch" href="/assets/js/93.0c6df625.js"><link rel="prefetch" href="/assets/js/94.3a387803.js"><link rel="prefetch" href="/assets/js/95.f3bf499d.js"><link rel="prefetch" href="/assets/js/96.3b95ac2a.js"><link rel="prefetch" href="/assets/js/97.54c1ad8f.js"><link rel="prefetch" href="/assets/js/98.b025ed29.js"><link rel="prefetch" href="/assets/js/99.146e244d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4250c2dd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">知鱼之乐@Android</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Android基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Android/01基础机制/1.Android系统启动流程.html" class="sidebar-link">Android系统启动过程</a></li><li><a href="/Android/01基础机制/2.Binder进程通信机制.html" class="sidebar-link">Binder进程通信机制</a></li><li><a href="/Android/07面试题/1.面试题-计算机基础.html" class="sidebar-link">1面试题-计算机基础</a></li><li><a href="/Android/07面试题/2.面试题-Android.html" class="sidebar-link">2面试题-Android</a></li><li><a href="/Android/07面试题/3.面试题-架构设计.html" class="sidebar-link">3面试题-架构设计</a></li><li><a href="/Android/07面试题/4.面试-业务实战.html" class="sidebar-link">4面试-业务实战</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>操作系统等</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/操作系统等/C编译原理.html" class="sidebar-link">C++编译原理</a></li><li><a href="/操作系统等/Linux常用操作手册.html" class="sidebar-link">Linux操作手册</a></li><li><a href="/操作系统等/IOS.html" class="sidebar-link">IOS</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Tools</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Tools/1.Mac开发快捷键大全.html" class="sidebar-link">Mac开发快捷键大全</a></li><li><a href="/Tools/2.翻墙工具指南.html" class="sidebar-link">翻墙工具指南</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>投名状</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ppt/警世通言.html" class="sidebar-link">警世通言</a></li><li><a href="/ppt/1.阿里技术合伙人.html" class="sidebar-link">阿里技术</a></li><li><a href="/ppt/2.企业家-雷军.html" class="sidebar-link">企业家-雷军</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="view绘制流程"><a href="#view绘制流程" class="header-anchor">#</a> View绘制流程</h1> <p>[TOC]</p> <blockquote><ol><li>setContentView会创建一个DocorView并将自定义的layout添加到DocorView；</li> <li>onResume时候会将DocorView添加到PhoneWindow上，并执行performTraversals开始绘制；</li> <li>onMeasure测量(<code>从顶层父View到子View递归调用measure方法，measure方法又回调OnMeasure</code>)；</li> <li>onLayout布局(<code>从顶层父View向子View的递归调用view.layout方法的过程，即父View根据上一步measure子View所得到的布局大小和布局参数，将子View放在合适的位置上</code>)；</li> <li>onDraw绘制(<code>ViewRoot创建一个Canvas对象，然后调用OnDraw()。六个步骤：①、绘制视图的背景；②、保存画布的图层（Layer）；③、绘制View的内容；④、绘制View子视图，如果没有就不用；⑤、还原图层（Layer）；⑥、绘制滚动条。</code>)；</li> <li>然后通过Surface将Canvas绘制到缓存区，每16毫秒，SurfaceFlinger进程合成多个Surface后调用opengl进行栅格化和最终显示。</li></ol> <p>问题：</p> <ol><li>MeasureSpec的三种模式和对子View的影响？</li></ol></blockquote> <h4 id="_1-基础知识点"><a href="#_1-基础知识点" class="header-anchor">#</a> 1. 基础知识点</h4> <h5 id="_1-前提"><a href="#_1-前提" class="header-anchor">#</a> 1. 前提</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleResumeActivity</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finalStateRequest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isForward<span class="token punctuation">,</span>
            <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>window <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>a<span class="token punctuation">.</span>mFinished <span class="token operator">&amp;&amp;</span> willBeVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>window <span class="token operator">=</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">View</span> decor <span class="token operator">=</span> r<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">getDecorView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            decor<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span>INVISIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ViewManager</span> wm <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">getWindowManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span> l <span class="token operator">=</span> r<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>mDecor <span class="token operator">=</span> decor<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>mVisibleFromClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>a<span class="token punctuation">.</span>mWindowAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    a<span class="token punctuation">.</span>mWindowAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment">//这里调用了WindowManager的addView()方法,而我们知道WindowManager的具体实现类是WindowManagerImpl,我们到WindowManagerImpl中查看addView()的实现</span>
                    wm<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>decor<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    a<span class="token punctuation">.</span><span class="token function">onWindowAttributesChanged</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WindowManagerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">WindowManager</span> <span class="token punctuation">{</span>
     <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ViewGroup<span class="token punctuation">.</span>LayoutParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">applyDefaultToken</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//这里调用了WindowManagerGlobal类的addView()方法</span>
        mGlobal<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> params<span class="token punctuation">,</span> mContext<span class="token punctuation">.</span><span class="token function">getDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mParentWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WindowManagerGlobal</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">ViewGroup<span class="token punctuation">.</span>LayoutParams</span> params<span class="token punctuation">,</span>
            <span class="token class-name">Display</span> display<span class="token punctuation">,</span> <span class="token class-name">Window</span> parentWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token class-name">ViewRootImpl</span> root<span class="token punctuation">;</span>
            <span class="token class-name">View</span> panelParentView <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewRootImpl</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> display<span class="token punctuation">)</span><span class="token punctuation">;</span>

            view<span class="token punctuation">.</span><span class="token function">setLayoutParams</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mViews<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mRoots<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mParams<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//这里调用了ViewRootImpl的setView()方法</span>
                root<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> wparams<span class="token punctuation">,</span> panelParentView<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> 
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ViewRootImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ViewParent</span><span class="token punctuation">,</span>
        <span class="token class-name">View<span class="token punctuation">.</span>AttachInfo<span class="token punctuation">.</span>Callbacks</span><span class="token punctuation">,</span> <span class="token class-name">ThreadedRenderer<span class="token punctuation">.</span>DrawCallbacks</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span> attrs<span class="token punctuation">,</span> <span class="token class-name">View</span> panelParentView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mView <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mView <span class="token operator">=</span> view<span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">//这里终于到了我们今天要开始分析的真正的主角</span>
                <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_2-view绘制的起点"><a href="#_2-view绘制的起点" class="header-anchor">#</a> 2.  View绘制的起点</h5> <p>​	ViewRootImpl类的<code>performTraversals()</code>是执行遍历的方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span> attrs<span class="token punctuation">,</span> <span class="token class-name">View</span> panelParentView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 1.触发绘制流程 </span>
      <span class="token comment">// 通信WMS添加显示view  2. 通过IPC 执行WMS.addWindow方法。</span>
      <span class="token comment">// 通过WindowSession进行IPC调用，将View添加到Window上</span>
      <span class="token comment">// mWindow即W类，用来接收WMS信息；同时通过InputChannel接收触摸事件回调。</span>
      res <span class="token operator">=</span> mWindowSession<span class="token punctuation">.</span><span class="token function">addToDisplay</span><span class="token punctuation">(</span>mWindow<span class="token punctuation">,</span> mSeq<span class="token punctuation">,</span> mWindowAttributes<span class="token punctuation">,</span>
                            <span class="token function">getHostVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mDisplay<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            mAttachInfo<span class="token punctuation">.</span>mContentInsets<span class="token punctuation">,</span> mAttachInfo<span class="token punctuation">.</span>mStableInsets<span class="token punctuation">,</span>
                            mAttachInfo<span class="token punctuation">.</span>mOutsets<span class="token punctuation">,</span> mInputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHandlingLayoutInLayoutRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查发起布局请求的线程是否为主线程  </span>
    <span class="token function">checkThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mLayoutRequested <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">scheduleTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 开始执行遍历三大流程</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token keyword">int</span> childWidthMeasureSpec <span class="token operator">=</span> <span class="token function">getRootMeasureSpec</span><span class="token punctuation">(</span>mWidth<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">int</span> childHeightMeasureSpec <span class="token operator">=</span> <span class="token function">getRootMeasureSpec</span><span class="token punctuation">(</span>mHeight<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token function">performMeasure</span><span class="token punctuation">(</span>childWidthMeasureSpec<span class="token punctuation">,</span> childHeightMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// mView.measure(childWidthMeasureSpec, childHeightMeasureSpec); </span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token function">performLayout</span><span class="token punctuation">(</span>lp<span class="token punctuation">,</span> mWidth<span class="token punctuation">,</span> mHeight<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// mView.layout(0, 0, mView.getMeasuredWidth(), mView.getMeasuredHeight());</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token function">performDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// mView.draw(canvas); </span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_3-measurespec原理"><a href="#_3-measurespec原理" class="header-anchor">#</a> 3. MeasureSpec原理</h5> <ul><li><p>what: MeasureSpec类是View类的一个静态内部类，一个MeasureSpec封装了从父容器<strong>传递</strong>给子容器的<strong>布局要求(规格参数测量参数)</strong>。子View的MeasureSpec是有父类的MS和子类本身的LayoutParams共同决定。</p></li> <li><p>Why: 主要用于父类向子类传递测量参数。</p></li> <li><p>how:组成部分</p> <p>由一个<code>int</code>类型的数字表示，分为2部分：mode(模式前两位)+size(大小后30位)；</p> <p>mode类型：</p> <ol><li>UNSPECIFIED：不对View大小做限制，如：ListView，ScrollView；</li> <li>EXACTLY：确切的大小，如：100dp或者march_parent；</li> <li>AT_MOST：大小不可超过某数值，如：wrap_content。</li></ol></li> <li><p><strong>如何计算某个View的MS？</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// spec:父类宽或高ms,padding:占用空间，childDimesion子view大小</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getChildMeasureSpec</span><span class="token punctuation">(</span><span class="token keyword">int</span> spec<span class="token punctuation">,</span> <span class="token keyword">int</span> padding<span class="token punctuation">,</span> <span class="token keyword">int</span> childDimension<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> specMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span><span class="token function">getMode</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> specSize <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> specSize <span class="token operator">-</span> padding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> resultSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> resultMode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>specMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Parent has imposed an exact size on us</span>
    若父<span class="token class-name">View</span>是EXACTLY，则父<span class="token class-name">View</span>有确切数值或者march_parent
    <span class="token keyword">case</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>EXACTLY<span class="token operator">:</span>
        若子<span class="token class-name">View</span>的childDimension大于<span class="token number">0</span>，则表示有确切数值，则子<span class="token class-name">View</span>大小为其本身且mode是<span class="token class-name">EXACTLY</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childDimension <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            resultSize <span class="token operator">=</span> childDimension<span class="token punctuation">;</span>
            resultMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>EXACTLY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        若子<span class="token class-name">View</span>的childDimension是MATCH_PARENT，则子<span class="token class-name">View</span>的大小为父<span class="token class-name">View</span>的大小且mode是EXACTLY
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childDimension <span class="token operator">==</span> <span class="token class-name">LayoutParams</span><span class="token punctuation">.</span>MATCH_PARENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Child wants to be our size. So be it.</span>
            resultSize <span class="token operator">=</span> size<span class="token punctuation">;</span>
            resultMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>EXACTLY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        若子<span class="token class-name">View</span>的childDimension是WRAP_CONTENT，则子<span class="token class-name">View</span>的大小为父<span class="token class-name">View</span>的大小且mode是AT_MOST，表示最大不可超过父<span class="token class-name">View</span>数值
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childDimension <span class="token operator">==</span> <span class="token class-name">LayoutParams</span><span class="token punctuation">.</span>WRAP_CONTENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Child wants to determine its own size. It can't be</span>
            <span class="token comment">// bigger than us.</span>
            resultSize <span class="token operator">=</span> size<span class="token punctuation">;</span>
            resultMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>AT_MOST<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token comment">// Parent has imposed a maximum size on us</span>
    若父<span class="token class-name">View</span>是AT_MOST，则父<span class="token class-name">View</span>一般是wrap_content，强给子<span class="token class-name">View</span>最大的值
    <span class="token keyword">case</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>AT_MOST<span class="token operator">:</span>
        若子<span class="token class-name">View</span>的childDimension大于<span class="token number">0</span>，则表示有确切数值，则子<span class="token class-name">View</span>大小为其本身且mode是<span class="token class-name">EXACTLY</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childDimension <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Child wants a specific size... so be it</span>
            resultSize <span class="token operator">=</span> childDimension<span class="token punctuation">;</span>
            resultMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>EXACTLY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        若子<span class="token class-name">View</span>的childDimension是MATCH_PARENT，则子<span class="token class-name">View</span>的大小不超过父<span class="token class-name">View</span>的大小且mode是AT_MOST
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childDimension <span class="token operator">==</span> <span class="token class-name">LayoutParams</span><span class="token punctuation">.</span>MATCH_PARENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Child wants to be our size, but our size is not fixed.</span>
            <span class="token comment">// Constrain child to not be bigger than us.</span>
            resultSize <span class="token operator">=</span> size<span class="token punctuation">;</span>
            resultMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>AT_MOST<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
       若子<span class="token class-name">View</span>的childDimension是WRAP_CONTENT，则子<span class="token class-name">View</span>的大小不超过父<span class="token class-name">View</span>的大小且mode是AT_MOST
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childDimension <span class="token operator">==</span> <span class="token class-name">LayoutParams</span><span class="token punctuation">.</span>WRAP_CONTENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Child wants to determine its own size. It can't be</span>
            <span class="token comment">// bigger than us.</span>
            resultSize <span class="token operator">=</span> size<span class="token punctuation">;</span>
            resultMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>AT_MOST<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token comment">// Parent asked to see how big we want to be</span>
    若父<span class="token class-name">View</span>是UNSPECIFIED，则父<span class="token class-name">View</span>不限制子<span class="token class-name">View</span>大小
    <span class="token keyword">case</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>UNSPECIFIED<span class="token operator">:</span>
    若子<span class="token class-name">View</span>的childDimension大于<span class="token number">0</span>，则表示有确切数值，则子<span class="token class-name">View</span>大小为其本身且mode是<span class="token class-name">EXACTLY</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childDimension <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Child wants a specific size... let him have it</span>
            resultSize <span class="token operator">=</span> childDimension<span class="token punctuation">;</span>
            resultMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>EXACTLY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        若子<span class="token class-name">View</span>的childDimension是MATCH_PARENT，因为父<span class="token class-name">View</span>是UNSPECIFIED，所以子<span class="token class-name">View</span>大小为<span class="token number">0</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childDimension <span class="token operator">==</span> <span class="token class-name">LayoutParams</span><span class="token punctuation">.</span>MATCH_PARENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Child wants to be our size... find out how big it should</span>
            <span class="token comment">// be</span>
            resultSize <span class="token operator">=</span> <span class="token class-name">View</span><span class="token punctuation">.</span>sUseZeroUnspecifiedMeasureSpec <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> size<span class="token punctuation">;</span>
            resultMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>UNSPECIFIED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        若子<span class="token class-name">View</span>的childDimension是WRAP_CONTENT，因为父<span class="token class-name">View</span>是UNSPECIFIED，所以子<span class="token class-name">View</span>大小为<span class="token number">0</span> 
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childDimension <span class="token operator">==</span> <span class="token class-name">LayoutParams</span><span class="token punctuation">.</span>WRAP_CONTENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Child wants to determine its own size.... find out how</span>
            <span class="token comment">// big it should be</span>
            resultSize <span class="token operator">=</span> <span class="token class-name">View</span><span class="token punctuation">.</span>sUseZeroUnspecifiedMeasureSpec <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> size<span class="token punctuation">;</span>
            resultMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>UNSPECIFIED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//noinspection ResourceType</span>
    <span class="token keyword">return</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span><span class="token function">makeMeasureSpec</span><span class="token punctuation">(</span>resultSize<span class="token punctuation">,</span> resultMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>总结一下：
不管父View是何模式，若子View有确切数值，则子View大小就是其本身大小，且mode是EXACTLY；
若子View是match_parent，则模式与父View相同，且大小同父View（若父View是UNSPECIFIED，则子View大小为0）；
若子View是wrap_content，则模式是AT_MOST，大小同父View，表示不可超过父View大小（若父View是UNSPECIFIED，则子View大小为0）。</p></li></ul> <h4 id="_2-三个阶段"><a href="#_2-三个阶段" class="header-anchor">#</a> 2. 三个阶段</h4> <p>View的整个绘制流程可以分为以下三个阶段：</p> <ul><li>measure: 判断是否需要重新计算View的大小，需要的话则计算(<code>从顶层父View到子View递归调用measure方法，measure方法又回调OnMeasure</code>)；</li> <li>layout: 判断是否需要重新计算View的位置，需要的话则计算(<code>从顶层父View向子View的递归调用view.layout方法的过程，即父View根据上一步measure子View所得到的布局大小和布局参数，将子View放在合适的位置上</code>)；</li> <li>draw: 判断是否需要重新绘制View，需要的话则重绘制(<code>ViewRoot创建一个Canvas对象，然后调用OnDraw()。六个步骤：①、绘制视图的背景；②、保存画布的图层（Layer）；③、绘制View的内容；④、绘制View子视图，如果没有就不用；⑤、还原图层（Layer）；⑥、绘制滚动条。</code>)。
这三个子阶段可以用下图来描述(measure和layout可以执行多次)：</li></ul> <p><img src="images/ui_view_draw.png" alt="ui_draw"></p> <h5 id="measure阶段"><a href="#measure阶段" class="header-anchor">#</a> measure阶段</h5> <h6 id="结论"><a href="#结论" class="header-anchor">#</a> 结论</h6> <p>​	通过<code>WindowManager</code>将<code>DecorView</code>传入<code>ViewRootImpl</code>,在<code>ViewRootImpl</code>中的<code>performTraversals()</code>方法中分别对<code>View</code>进行<code>measure</code>, <code>layout</code>, <code>draw</code>,通过<code>ViewGroup</code>的类分别对子<code>View</code>依次进行测量,摆放和绘制。</p> <p>​	View树的绘制是从ViewRoot的performTraversals()方法开始，这个方法的主要作用是判断是否重新measure、是否重新layout、是否重新draw。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">int</span> childWidthMeasureSpec <span class="token operator">=</span> <span class="token function">getRootMeasureSpec</span><span class="token punctuation">(</span>mWidth<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> childHeightMeasureSpec <span class="token operator">=</span> <span class="token function">getRootMeasureSpec</span><span class="token punctuation">(</span>mHeight<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mView<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span>childWidthMeasureSpec<span class="token punctuation">,</span> childHeightMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// mView=DocorView</span>
        mView<span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mView<span class="token punctuation">.</span><span class="token function">getMeasuredWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mView<span class="token punctuation">.</span><span class="token function">getMeasuredHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mView<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

		<span class="token comment">// 1. 获取DecorView的MeasureSpec,默认屏幕像素高</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getRootMeasureSpec</span><span class="token punctuation">(</span><span class="token keyword">int</span> windowSize<span class="token punctuation">,</span> <span class="token keyword">int</span> rootDimension<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> measureSpec<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>rootDimension<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">ViewGroup<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span>MATCH_PARENT<span class="token operator">:</span>
                measureSpec <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span><span class="token function">makeMeasureSpec</span><span class="token punctuation">(</span>windowSize<span class="token punctuation">,</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>EXACTLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">ViewGroup<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span>WRAP_CONTENT<span class="token operator">:</span>
                measureSpec <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span><span class="token function">makeMeasureSpec</span><span class="token punctuation">(</span>windowSize<span class="token punctuation">,</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>AT_MOST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                measureSpec <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span><span class="token function">makeMeasureSpec</span><span class="token punctuation">(</span>rootDimension<span class="token punctuation">,</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>EXACTLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> measureSpec<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 

		<span class="token comment">// 计算View大小，调用onMeasure</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">measure</span><span class="token punctuation">(</span><span class="token keyword">int</span> widthMeasureSpec<span class="token punctuation">,</span> <span class="token keyword">int</span> heightMeasureSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> FORCE_LAYOUT<span class="token punctuation">)</span> <span class="token operator">==</span> FORCE_LAYOUT <span class="token operator">||</span>
                widthMeasureSpec <span class="token operator">!=</span> mOldWidthMeasureSpec <span class="token operator">||</span>
                heightMeasureSpec <span class="token operator">!=</span> mOldHeightMeasureSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mPrivateFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>MEASURED_DIMENSION_SET<span class="token punctuation">;</span>
          	<span class="token comment">// 执行onMeasure</span>
            <span class="token function">onMeasure</span><span class="token punctuation">(</span>widthMeasureSpec<span class="token punctuation">,</span> heightMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPrivateFlags <span class="token operator">|=</span> LAYOUT_REQUIRED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mOldWidthMeasureSpec <span class="token operator">=</span> widthMeasureSpec<span class="token punctuation">;</span>
        mOldHeightMeasureSpec <span class="token operator">=</span> heightMeasureSpec<span class="token punctuation">;</span>
      
        mMeasureCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> mMeasuredWidth<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token operator">|</span>
                <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> mMeasuredHeight <span class="token operator">&amp;</span> <span class="token number">0</span>xffffffffL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// suppress sign extension</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//View的onMeasure默认实现方法，设置View的长和宽；如果写死，则外边变化时界面不变化</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onMeasure</span><span class="token punctuation">(</span><span class="token keyword">int</span> widthMeasureSpec<span class="token punctuation">,</span> <span class="token keyword">int</span> heightMeasureSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setMeasuredDimension</span><span class="token punctuation">(</span><span class="token function">getDefaultSize</span><span class="token punctuation">(</span><span class="token function">getSuggestedMinimumWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> widthMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">getDefaultSize</span><span class="token punctuation">(</span><span class="token function">getSuggestedMinimumHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> heightMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getDefaultSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> measureSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> size<span class="token punctuation">;</span>
        <span class="token keyword">int</span> specMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span><span class="token function">getMode</span><span class="token punctuation">(</span>measureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> specSize <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span>measureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>specMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>UNSPECIFIED<span class="token operator">:</span>
                result <span class="token operator">=</span> size<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>AT_MOST<span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>EXACTLY<span class="token operator">:</span>
                result <span class="token operator">=</span> specSize<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>如果是ViewGroup，还应该进行嵌套测量</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ViewGroup的默认实现</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">measureChildren</span><span class="token punctuation">(</span><span class="token keyword">int</span> widthMeasureSpec<span class="token punctuation">,</span> <span class="token keyword">int</span> heightMeasureSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> mChildrenCount<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">View</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children <span class="token operator">=</span> mChildren<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">View</span> child <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>mViewFlags <span class="token operator">&amp;</span> VISIBILITY_MASK<span class="token punctuation">)</span> <span class="token operator">!=</span> GONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">measureChild</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> widthMeasureSpec<span class="token punctuation">,</span> heightMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">measureChild</span><span class="token punctuation">(</span><span class="token class-name">View</span> child<span class="token punctuation">,</span> <span class="token keyword">int</span> parentWidthMeasureSpec<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> parentHeightMeasureSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">LayoutParams</span> lp <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getLayoutParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> childWidthMeasureSpec <span class="token operator">=</span> <span class="token function">getChildMeasureSpec</span><span class="token punctuation">(</span>parentWidthMeasureSpec<span class="token punctuation">,</span>
                mPaddingLeft <span class="token operator">+</span> mPaddingRight<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> childHeightMeasureSpec <span class="token operator">=</span> <span class="token function">getChildMeasureSpec</span><span class="token punctuation">(</span>parentHeightMeasureSpec<span class="token punctuation">,</span>
                mPaddingTop <span class="token operator">+</span> mPaddingBottom<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        child<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span>childWidthMeasureSpec<span class="token punctuation">,</span> childHeightMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getChildMeasureSpec</span><span class="token punctuation">(</span><span class="token keyword">int</span> spec<span class="token punctuation">,</span> <span class="token keyword">int</span> padding<span class="token punctuation">,</span> <span class="token keyword">int</span> childDimension<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> specMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span><span class="token function">getMode</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> specSize <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> specSize <span class="token operator">-</span> padding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> resultSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> resultMode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>specMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>EXACTLY<span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>childDimension <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    resultSize <span class="token operator">=</span> childDimension<span class="token punctuation">;</span>
                    resultMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>EXACTLY<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childDimension <span class="token operator">==</span> <span class="token class-name">LayoutParams</span><span class="token punctuation">.</span>MATCH_PARENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    resultSize <span class="token operator">=</span> size<span class="token punctuation">;</span>
                    resultMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>EXACTLY<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childDimension <span class="token operator">==</span> <span class="token class-name">LayoutParams</span><span class="token punctuation">.</span>WRAP_CONTENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Child wants to determine its own size. It can't be</span>
                    <span class="token comment">// bigger than us.</span>
                    resultSize <span class="token operator">=</span> size<span class="token punctuation">;</span>
                    resultMode <span class="token operator">=</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span>AT_MOST<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//将mode与size通过MeasureSpec方法整合为32位整数返回</span>
        <span class="token keyword">return</span> <span class="token class-name">MeasureSpec</span><span class="token punctuation">.</span><span class="token function">makeMeasureSpec</span><span class="token punctuation">(</span>resultSize<span class="token punctuation">,</span> resultMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><strong>FrameLayout实现例子：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//FrameLayout 的测量实现</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onMeasure</span><span class="token punctuation">(</span><span class="token keyword">int</span> widthMeasureSpec<span class="token punctuation">,</span> <span class="token keyword">int</span> heightMeasureSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">int</span> maxHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> maxWidth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> childState <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
   <span class="token keyword">final</span> <span class="token class-name">View</span> child <span class="token operator">=</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    
   <span class="token keyword">if</span> <span class="token punctuation">(</span>mMeasureAllChildren <span class="token operator">||</span> child<span class="token punctuation">.</span><span class="token function">getVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> GONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>   
    <span class="token comment">// 遍历自己的子View，只要不是GONE的都会参与测量，measureChildWithMargins方法在最上面</span>
    <span class="token comment">// 的源码已经讲过了，如果忘了回头去看看，基本思想就是父View把自己当MeasureSpec </span>
    <span class="token comment">// 传给子View结合子View自己的LayoutParams 算出子View 的MeasureSpec，然后继续往下穿，</span>
    <span class="token comment">// 传递叶子节点，叶子节点没有子View，只要负责测量自己就好了。</span>
     <span class="token function">measureChildWithMargins</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> widthMeasureSpec<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> heightMeasureSpec<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>  

</code></pre></div><p>​	每个View控件的实际宽高都是由父视图和自身决定的。实际的测量是在onMeasure方法进行，所以在View的子类需要重写onMeasure方法，这是因为measure方法是final的，不允许重载，所以View子类只能通过重载onMeasure来实现自己的测量逻辑。</p> <h5 id="layout阶段"><a href="#layout阶段" class="header-anchor">#</a> layout阶段</h5> <p>测量完各个组件的大小之后，就可以排列他们的位置了。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">int</span> childWidthMeasureSpec <span class="token operator">=</span> <span class="token function">getRootMeasureSpec</span><span class="token punctuation">(</span>mWidth<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> childHeightMeasureSpec <span class="token operator">=</span> <span class="token function">getRootMeasureSpec</span><span class="token punctuation">(</span>mHeight<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mView<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span>childWidthMeasureSpec<span class="token punctuation">,</span> childHeightMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mView<span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mView<span class="token punctuation">.</span><span class="token function">getMeasuredWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mView<span class="token punctuation">.</span><span class="token function">getMeasuredHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mView<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">layout</span><span class="token punctuation">(</span><span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> oldL <span class="token operator">=</span> mLeft<span class="token punctuation">;</span>
        <span class="token keyword">int</span> oldT <span class="token operator">=</span> mTop<span class="token punctuation">;</span>
        <span class="token keyword">int</span> oldB <span class="token operator">=</span> mBottom<span class="token punctuation">;</span>
        <span class="token keyword">int</span> oldR <span class="token operator">=</span> mRight<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> changed <span class="token operator">=</span> <span class="token function">setFrame</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> t<span class="token punctuation">,</span> r<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//视图大小是否发生变化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>changed <span class="token operator">||</span> <span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> LAYOUT_REQUIRED<span class="token punctuation">)</span> <span class="token operator">==</span> LAYOUT_REQUIRED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	<span class="token comment">// 调用onLayout</span>
            <span class="token function">onLayout</span><span class="token punctuation">(</span>changed<span class="token punctuation">,</span> l<span class="token punctuation">,</span> t<span class="token punctuation">,</span> r<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPrivateFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>LAYOUT_REQUIRED<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mOnLayoutChangeListeners <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OnLayoutChangeListener</span><span class="token punctuation">&gt;</span></span> listenersCopy <span class="token operator">=</span>
                        <span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OnLayoutChangeListener</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> mOnLayoutChangeListeners<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> numListeners <span class="token operator">=</span> listenersCopy<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numListeners<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    listenersCopy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onLayoutChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> t<span class="token punctuation">,</span> r<span class="token punctuation">,</span> b<span class="token punctuation">,</span> oldL<span class="token punctuation">,</span> oldT<span class="token punctuation">,</span> oldR<span class="token punctuation">,</span> oldB<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        mPrivateFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>FORCE_LAYOUT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>​	View中的onLayout()方法就是一个空方法，因为onLayout()过程是为了确定视图在布局中所在的位置，而这个操作应该是由布局来完成的，即父视图决定子视图的显示位置。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// View的onLayout方法(空方法)</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onLayout</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> changed<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> bottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token comment">// ViewGroup的onLayout方法(子类必须实现)</span>
<span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">onLayout</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> changed<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre></div><p>​	然而，ViewGroup中的onLayout()方法是一个抽象方法，这就意味着所有ViewGroup的子类都必须重写这个方法。自定义ViewGroup控件中，onLayout配合onMeasure方法一起使用可以实现自定义View的复杂布局。自定义View首先调用onMeasure进行测量，然后调用onLayout方法动态获取子View和子View的测量大小，然后进行layout布局。重载onLayout的目的就是安排其children在父View的具体位置，重载onLayout通常做法就是写一个for循环调用每一个子视图的layout(l, t, r, b)函数，传入不同的参数l, t, r, b来确定每个子视图在父视图中的显示位置。</p> <p>下面代码以LinearLayout举例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinearLayout</span> <span class="token keyword">extends</span> <span class="token class-name">ViewGroup</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onLayout</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> changed<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOrientation <span class="token operator">==</span> VERTICAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">layoutVertical</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> t<span class="token punctuation">,</span> r<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">layoutHorizontal</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> t<span class="token punctuation">,</span> r<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">layoutVertical</span><span class="token punctuation">(</span><span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> bottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> paddingLeft <span class="token operator">=</span> mPaddingLeft<span class="token punctuation">;</span>
        <span class="token keyword">int</span> childTop<span class="token punctuation">;</span>
        <span class="token keyword">int</span> childLeft<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> width <span class="token operator">=</span> right <span class="token operator">-</span> left<span class="token punctuation">;</span>
        <span class="token keyword">int</span> childRight <span class="token operator">=</span> width <span class="token operator">-</span> mPaddingRight<span class="token punctuation">;</span>
        <span class="token keyword">int</span> childSpace <span class="token operator">=</span> width <span class="token operator">-</span> paddingLeft <span class="token operator">-</span> mPaddingRight<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">getVirtualChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> majorGravity <span class="token operator">=</span> mGravity <span class="token operator">&amp;</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span>VERTICAL_GRAVITY_MASK<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> minorGravity <span class="token operator">=</span> mGravity <span class="token operator">&amp;</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span>RELATIVE_HORIZONTAL_GRAVITY_MASK<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>majorGravity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span>BOTTOM<span class="token operator">:</span>
                childTop <span class="token operator">=</span> mPaddingTop <span class="token operator">+</span> bottom <span class="token operator">-</span> top <span class="token operator">-</span> mTotalLength<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span>CENTER_VERTICAL<span class="token operator">:</span>
                childTop <span class="token operator">=</span> mPaddingTop <span class="token operator">+</span> <span class="token punctuation">(</span>bottom <span class="token operator">-</span> top <span class="token operator">-</span> mTotalLength<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span>TOP<span class="token operator">:</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                childTop <span class="token operator">=</span> mPaddingTop<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           	<span class="token comment">// 遍历子View</span>
            <span class="token keyword">final</span> <span class="token class-name">View</span> child <span class="token operator">=</span> <span class="token function">getVirtualChildAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                childTop <span class="token operator">+=</span> <span class="token function">measureNullChild</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> GONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> childWidth <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getMeasuredWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> childHeight <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getMeasuredHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">LinearLayout<span class="token punctuation">.</span>LayoutParams</span> lp <span class="token operator">=</span>
                        <span class="token punctuation">(</span><span class="token class-name">LinearLayout<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">)</span> child<span class="token punctuation">.</span><span class="token function">getLayoutParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> gravity <span class="token operator">=</span> lp<span class="token punctuation">.</span>gravity<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>gravity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    gravity <span class="token operator">=</span> minorGravity<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> layoutDirection <span class="token operator">=</span> <span class="token function">getLayoutDirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> absoluteGravity <span class="token operator">=</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span><span class="token function">getAbsoluteGravity</span><span class="token punctuation">(</span>gravity<span class="token punctuation">,</span> layoutDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>absoluteGravity <span class="token operator">&amp;</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span>HORIZONTAL_GRAVITY_MASK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span>CENTER_HORIZONTAL<span class="token operator">:</span>
                        childLeft <span class="token operator">=</span> paddingLeft <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>childSpace <span class="token operator">-</span> childWidth<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> lp<span class="token punctuation">.</span>leftMargin <span class="token operator">-</span> lp<span class="token punctuation">.</span>rightMargin<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span>RIGHT<span class="token operator">:</span>
                        childLeft <span class="token operator">=</span> childRight <span class="token operator">-</span> childWidth <span class="token operator">-</span> lp<span class="token punctuation">.</span>rightMargin<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token class-name">Gravity</span><span class="token punctuation">.</span>LEFT<span class="token operator">:</span>
                    <span class="token keyword">default</span><span class="token operator">:</span>
                        childLeft <span class="token operator">=</span> paddingLeft <span class="token operator">+</span> lp<span class="token punctuation">.</span>leftMargin<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasDividerBeforeChildAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    childTop <span class="token operator">+=</span> mDividerHeight<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                childTop <span class="token operator">+=</span> lp<span class="token punctuation">.</span>topMargin<span class="token punctuation">;</span>
              	<span class="token comment">// 确定矩形大小，在调用子view的OnLayout计算最终大</span>
                <span class="token function">setChildFrame</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> childLeft<span class="token punctuation">,</span> childTop <span class="token operator">+</span> <span class="token function">getLocationOffset</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        childWidth<span class="token punctuation">,</span> childHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
                childTop <span class="token operator">+=</span> childHeight <span class="token operator">+</span> lp<span class="token punctuation">.</span>bottomMargin <span class="token operator">+</span> <span class="token function">getNextLocationOffset</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
                i <span class="token operator">+=</span> <span class="token function">getChildrenSkipCount</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h5 id="draw阶段"><a href="#draw阶段" class="header-anchor">#</a> draw阶段</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">final</span> <span class="token keyword">int</span> privateFlags <span class="token operator">=</span> mPrivateFlags<span class="token punctuation">;</span>  
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> dirtyOpaque <span class="token operator">=</span> <span class="token punctuation">(</span>privateFlags <span class="token operator">&amp;</span> DIRTY_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> DIRTY_OPAQUE <span class="token operator">&amp;&amp;</span>  
            <span class="token punctuation">(</span>mAttachInfo <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mAttachInfo<span class="token punctuation">.</span>mIgnoreDirtyState<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    mPrivateFlags <span class="token operator">=</span> <span class="token punctuation">(</span>privateFlags <span class="token operator">&amp;</span> <span class="token operator">~</span>DIRTY_MASK<span class="token punctuation">)</span> <span class="token operator">|</span> DRAWN<span class="token punctuation">;</span>  
    <span class="token comment">// Step 1, draw the background, if needed  </span>
    <span class="token keyword">int</span> saveCount<span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirtyOpaque<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">final</span> <span class="token class-name">Drawable</span> background <span class="token operator">=</span> mBGDrawable<span class="token punctuation">;</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>background <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">final</span> <span class="token keyword">int</span> scrollX <span class="token operator">=</span> mScrollX<span class="token punctuation">;</span>  
            <span class="token keyword">final</span> <span class="token keyword">int</span> scrollY <span class="token operator">=</span> mScrollY<span class="token punctuation">;</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mBackgroundSizeChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                background<span class="token punctuation">.</span><span class="token function">setBounds</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>  mRight <span class="token operator">-</span> mLeft<span class="token punctuation">,</span> mBottom <span class="token operator">-</span> mTop<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                mBackgroundSizeChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scrollX <span class="token operator">|</span> scrollY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                background<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  
                canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>scrollX<span class="token punctuation">,</span> scrollY<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                background<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token operator">-</span>scrollX<span class="token punctuation">,</span> <span class="token operator">-</span>scrollY<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">final</span> <span class="token keyword">int</span> viewFlags <span class="token operator">=</span> mViewFlags<span class="token punctuation">;</span>  
    <span class="token keyword">boolean</span> horizontalEdges <span class="token operator">=</span> <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> FADING_EDGE_HORIZONTAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">boolean</span> verticalEdges <span class="token operator">=</span> <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> FADING_EDGE_VERTICAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>verticalEdges <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>horizontalEdges<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token comment">// Step 3, draw the content  </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirtyOpaque<span class="token punctuation">)</span> <span class="token function">onDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment">// Step 4, draw the children  </span>
        <span class="token function">dispatchDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment">// Step 6, draw decorations (scrollbars)  </span>
        <span class="token function">onDrawScrollBars</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment">// we're done...  </span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><ul><li>参考</li></ul> <p><a href="https://www.jianshu.com/p/f05d6b05ba17" target="_blank" rel="noopener noreferrer">1. 触摸事件原理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://zhuanlan.zhihu.com/p/26893970?utm_source=com.samsung.android.messaging&amp;utm_medium=social" target="_blank" rel="noopener noreferrer">2. 浅析 Android 输入事件处理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5b95a7b9.js" defer></script><script src="/assets/js/2.fdca36f3.js" defer></script><script src="/assets/js/25.4d01832f.js" defer></script>
  </body>
</html>
